---
milestone: v1.1
audited: 2026-02-27T19:00:00Z
status: gaps_found
scores:
  requirements: 20/34
  phases: 4/7 (12-15 complete, 16-18 not started)
  integration: 18/20 connections wired
  flows: 2/3 E2E flows functional
gaps:
  requirements:
    - id: "CODE-01"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started — no directory, no plans, no implementation"
    - id: "CODE-02"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started"
    - id: "CODE-03"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started"
    - id: "CODE-04"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "CODE-05"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "CODE-06"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "CODE-07"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started"
    - id: "CODE-08"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "CODE-09"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started"
    - id: "PERS-03"
      status: "unsatisfied"
      phase: "Phase 18"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 18 not started"
    - id: "UI-01"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "UI-02"
      status: "unsatisfied"
      phase: "Phase 18"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 18 not started"
    - id: "UI-05"
      status: "unsatisfied"
      phase: "Phase 18"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 18 not started"
    - id: "CLI-03"
      status: "unsatisfied"
      phase: "Phase 18"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 18 not started"
  integration:
    - from: "library_tab.py (_load_model_handler)"
      to: "generate_tab.py (prior controls)"
      issue: "_load_model_handler always calls load_model() (v1 loader). v2 VQ-VAE files raise ValueError. app_state.loaded_vq_model never set. Prior generation unreachable via UI."
      requirements: ["UI-04", "GEN-02", "GEN-03", "GEN-04"]
    - from: "app.py (cross-tab wiring)"
      to: "generate_tab.py (_update_generate_tab_for_model)"
      issue: "_update_generate_tab_for_model exists but is never imported into app.py or wired as a cross-tab event handler. prior_controls_section stays permanently hidden."
      requirements: ["UI-04"]
  flows:
    - flow: "UI: Train VQ-VAE → Load model → Generate from Prior"
      status: "broken"
      breaks_at: "Library tab load fails on v2 files (ValueError); loaded_vq_model never set; prior controls never shown"
      requirements: ["UI-04", "GEN-02", "GEN-03", "GEN-04"]
    - flow: "CLI: distill train → distill train-prior → distill generate"
      status: "complete"
    - flow: "CLI: Save v2 model → load_model_v2 → generate_audio_from_prior"
      status: "complete"
tech_debt:
  - phase: 02-data-pipeline-foundation
    items:
      - "Public API export gap: augmentation/preprocessing not in audio/__init__.py"
  - phase: 04-audio-quality-export
    items:
      - "6 human verification items pending (spectral analysis, crossfade quality, stereo field, etc.)"
  - phase: 05-musically-meaningful-controls
    items:
      - "4 human verification items pending (perceptual slider validation)"
  - phase: 10-multi-format-export-spatial-audio
    items:
      - "HRTF SOFA file not bundled (binaural mode requires user download)"
      - "6 human verification items pending (multi-format quality, spatial effects)"
  - phase: 13-vq-vae-training-pipeline
    items:
      - "dead_codes vs dead_code_count key discrepancy between UI and CLI codebook health display"
      - "TrainingRunner has no resume_vqvae() — resume button hidden in UI"
  - phase: 14-autoregressive-prior
    items:
      - "No UI path to prior training — users must use CLI after UI-based VQ-VAE training"
---

# Milestone v1.1 VQ-VAE — Audit Report

**Audited:** 2026-02-27
**Status:** gaps_found
**Previous audit:** 2026-02-22 (phases 12-14 only; Phase 15 was not started)

## Executive Summary

Milestone v1.1 "VQ-VAE" is **in progress** with phases 12-15 complete and phases 16-18 not started. The completed work delivers a fully functional VQ-VAE + autoregressive prior + generation pipeline via CLI. All 20 requirements in completed phases pass the 3-source cross-reference. However, the **UI path for prior-based generation is broken** — two critical integration gaps prevent users from loading v2 models and accessing prior controls through the Gradio interface. The CLI path works end-to-end.

14 requirements remain unsatisfied in unstarted phases 16-18 (code manipulation, diagnostics, library integration).

## Scores

| Category | Score | Details |
|----------|-------|---------|
| Requirements | **20/34** | 20 satisfied (phases 12-15), 14 pending (phases 16-18) |
| Phases | **4/7** | 12, 13, 14, 15 passed; 16-18 not started |
| Integration | **18/20** | 2 critical breaks in UI model loading and cross-tab wiring |
| E2E Flows | **2/3** | CLI full pipeline + CLI save/load/generate work; UI prior generation broken |

## Phase Verification Summary

| Phase | Status | Score | Key Notes |
|-------|--------|-------|-----------|
| 12 - RVQ-VAE Core Architecture | **PASSED** | 4/4 | ConvVQVAE, adaptive sizing, EMA+k-means, commitment loss |
| 13 - VQ-VAE Training Pipeline | **PASSED** | 5/5 | Training loop, codebook health, v2 persistence, UI/CLI |
| 14 - Autoregressive Prior | **PASSED** | 12/12 | CodePrior, memorization detection, bundling (gap resolved in 6bb0bb4) |
| 15 - Generation Pipeline | **PASSED** | 4/4 | sample_code_sequence, generate_audio_from_prior, UI controls, CLI flags |
| 16 - Encode/Decode + Code Viz | NOT STARTED | — | — |
| 17 - Code Editing | NOT STARTED | — | — |
| 18 - Diagnostics + Library | NOT STARTED | — | — |

## Requirements Coverage (3-Source Cross-Reference)

### Satisfied Requirements (20/34) — Phases 12-15

| REQ-ID | VERIFICATION | SUMMARY Frontmatter | Traceability | Final |
|--------|-------------|---------------------|-------------|-------|
| VQVAE-01 | passed (P12) | 12-01 | [x] Complete | **satisfied** |
| VQVAE-02 | passed (P12) | 12-01 | [x] Complete | **satisfied** |
| VQVAE-03 | passed (P12) | 12-01 | [x] Complete | **satisfied** |
| VQVAE-04 | passed (P13) | 13-01 | [x] Complete | **satisfied** |
| VQVAE-05 | passed (P12) | 12-02 | [x] Complete | **satisfied** |
| VQVAE-06 | passed (P12) | 12-01 | [x] Complete | **satisfied** |
| VQVAE-07 | passed (P13) | 13-01 | [x] Complete | **satisfied** |
| GEN-01 | passed (P14) | 14-01, 14-02 | [x] Complete | **satisfied** |
| GEN-02 | passed (P15) | 15-01 | [x] Complete | **satisfied** |
| GEN-03 | passed (P15) | 15-01 | [x] Complete | **satisfied** |
| GEN-04 | passed (P15) | 15-01 | [x] Complete | **satisfied** |
| GEN-05 | passed (P14) | 14-03 | [x] Complete | **satisfied** |
| GEN-06 | passed (P14) | 14-02 | [x] Complete | **satisfied** |
| PERS-01 | passed (P13) | 13-01 | [x] Complete | **satisfied** |
| PERS-02 | passed (P14) | 14-03 | [x] Complete | **satisfied** |
| UI-03 | passed (P13) | 13-02 | [x] Complete | **satisfied** |
| UI-04 | passed (P15) | 15-02 | [x] Complete | **satisfied** * |
| CLI-01 | passed (P13) | 13-03 | [x] Complete | **satisfied** |
| CLI-02 | passed (P14) | 14-03 | [x] Complete | **satisfied** |
| CLI-04 | passed (P15) | 15-03 | [x] Complete | **satisfied** |

\* **UI-04 note:** Phase-level code verification passes (generate tab controls exist and wire to `generate_audio_from_prior`), but the **UI flow is broken** at the integration level — see Integration Issues below. The requirement is architecturally satisfied but not reachable by users through the UI.

**Orphaned requirements:** 0 — all 34 v1.1 requirements are assigned to phases.

### Unsatisfied Requirements (14/34) — Phases 16-18 Not Started

| Phase | Requirements | Count |
|-------|-------------|-------|
| Phase 16 (Encode/Decode + Code Viz) | CODE-01, CODE-02, CODE-03, CODE-07, CODE-09 | 5 |
| Phase 17 (Code Editing) | CODE-04, CODE-05, CODE-06, CODE-08, UI-01 | 5 |
| Phase 18 (Diagnostics + Library) | PERS-03, UI-02, UI-05, CLI-03 | 4 |

All 14 are in phases with no directories, no plans, and no implementation. These represent remaining planned work, not failures.

## Integration Issues (Critical)

### 1. Library tab cannot load v2 VQ-VAE models

**Files:** `library_tab.py` (`_load_model_handler`), `persistence.py:330`

`_load_model_handler` always calls `load_model()` (v1 loader). v2 `.distill` files have `version=2`, which triggers `ValueError: Model version 2 is newer than supported version 1`. Additionally, the handler only sets `app_state.loaded_model` — it never calls `load_model_v2()` or sets `app_state.loaded_vq_model`.

**Impact:** Users cannot load VQ-VAE models through the Library tab UI. The entire UI path for prior-based generation is dead.

**Fix:** `_load_model_handler` must detect v2 files and dispatch to `load_model_v2()`, then set `app_state.loaded_vq_model`.

**Affected requirements:** UI-04, GEN-02, GEN-03, GEN-04 (UI paths)

### 2. Prior controls visibility never triggered in app.py

**Files:** `app.py:115-123`, `generate_tab.py:824` (`_update_generate_tab_for_model`)

`_update_generate_tab_for_model` exists and correctly toggles `prior_controls_section` visibility based on whether a VQ-VAE model with prior is loaded. However, it is **never imported into `app.py`** and **never wired as a cross-tab event handler**. After Library load, only `_update_sliders_for_model` (v1.0 path) runs. The `prior_controls_section` stays permanently `visible=False`.

**Impact:** Even if issue #1 were fixed, the prior generation UI would remain hidden.

**Fix:** `app.py` must import and wire `_update_generate_tab_for_model` as a chained handler after Library load.

**Affected requirements:** UI-04

### E2E Flow Status

| Flow | Status | Details |
|------|--------|---------|
| **CLI:** `distill train` → `distill train-prior` → `distill generate` | **COMPLETE** | All wiring verified end-to-end |
| **CLI:** Save v2 model → `load_model_v2` → `generate_audio_from_prior` | **COMPLETE** | `_load_by_version` correctly dispatches v2 |
| **UI:** Train VQ-VAE → Load model → Generate from Prior | **BROKEN** | Library load fails on v2; `loaded_vq_model` never set; prior controls never shown |

## Tech Debt

| Phase | Item | Severity |
|-------|------|----------|
| 02 | Public API export gap (augmentation/preprocessing) | Low |
| 04 | 6 human verification items (audio quality) | Info |
| 05 | 4 human verification items (perceptual) | Info |
| 10 | HRTF file not bundled; 6 human verification items | Low/Info |
| 13 | `dead_codes` vs `dead_code_count` key name discrepancy | Low |
| 13 | TrainingRunner has no `resume_vqvae()` | Low |
| 14 | No UI path to prior training (CLI only) | Medium |

**Total:** 7 items across 6 phases; 18 human verification items from v1.0 phases.

## Completed Phases Detail

### Phase 12: RVQ-VAE Core Architecture — PASSED

- **4/4 success criteria** verified
- **5/5 requirements** satisfied (VQVAE-01, 02, 03, 05, 06)
- ConvVQVAE (548 lines) with QuantizerWrapper around ResidualVQ
- VQVAEConfig (21 fields) with get_adaptive_vqvae_config (3-tier sizing)
- vqvae_loss + multi_scale_mel_loss (no KL, no free bits, no annealing)

### Phase 13: VQ-VAE Training Pipeline — PASSED

- **5/5 success criteria** verified
- **5/5 requirements** satisfied (VQVAE-04, 07, PERS-01, UI-03, CLI-01)
- train_vqvae loop (730 lines), VQ metrics, codebook health monitoring
- v2 persistence (save_model_v2 / load_model_v2 / LoadedVQModel)
- Gradio VQ controls and CLI flags
- 2 low-severity tech debt items

### Phase 14: Autoregressive Prior — PASSED

- **12/12 must-haves** verified (1 gap found and resolved in commit 6bb0bb4)
- **5/5 requirements** satisfied (GEN-01, 05, 06, PERS-02, CLI-02)
- CodePrior transformer, flatten/unflatten utilities
- train_prior orchestrator (685 lines) with memorization detection
- save_prior_to_model atomic bundling, prior reconstruction on load
- CLI train-prior command (257 lines) with Rich and SIGINT handling

### Phase 15: Generation Pipeline — PASSED

- **4/4 success criteria** verified
- **5/5 requirements** satisfied (GEN-02, 03, 04, UI-04, CLI-04)
- sample_code_sequence with temperature, top-k, top-p (prior.py)
- generate_audio_from_prior with multi-chunk crossfade stitching (generation.py)
- Prior controls section in generate tab (temperature, top-k, top-p sliders)
- CLI --temperature, --top-k, --top-p, --overlap flags

---

*Audited: 2026-02-27T19:00:00Z*
*Auditor: Claude (gsd-audit-milestone)*
