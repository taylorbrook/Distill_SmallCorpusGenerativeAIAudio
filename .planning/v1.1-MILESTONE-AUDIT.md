---
milestone: v1.1
audited: 2026-02-22T12:00:00Z
status: gaps_found
scores:
  requirements: 15/34
  phases: 3/7
  integration: 17/18
  flows: 1/2
gaps:
  requirements:
    - id: "GEN-02"
      status: "unsatisfied"
      phase: "Phase 15"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 15 not started"
    - id: "GEN-03"
      status: "unsatisfied"
      phase: "Phase 15"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 15 not started"
    - id: "GEN-04"
      status: "unsatisfied"
      phase: "Phase 15"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 15 not started"
    - id: "UI-04"
      status: "unsatisfied"
      phase: "Phase 15"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 15 not started"
    - id: "CLI-04"
      status: "unsatisfied"
      phase: "Phase 15"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 15 not started"
    - id: "CODE-01"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started"
    - id: "CODE-02"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started"
    - id: "CODE-03"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started"
    - id: "CODE-07"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started"
    - id: "CODE-09"
      status: "unsatisfied"
      phase: "Phase 16"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 16 not started"
    - id: "CODE-04"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "CODE-05"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "CODE-06"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "CODE-08"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "UI-01"
      status: "unsatisfied"
      phase: "Phase 17"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 17 not started"
    - id: "PERS-03"
      status: "unsatisfied"
      phase: "Phase 18"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 18 not started"
    - id: "UI-02"
      status: "unsatisfied"
      phase: "Phase 18"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 18 not started"
    - id: "UI-05"
      status: "unsatisfied"
      phase: "Phase 18"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 18 not started"
    - id: "CLI-03"
      status: "unsatisfied"
      phase: "Phase 18"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 18 not started"
  integration:
    - from: "Phase 14 (prior training)"
      to: "Gradio UI"
      issue: "No UI path to train_prior — users must use CLI after UI-based VQ-VAE training"
      requirements: ["GEN-01"]
  flows:
    - flow: "UI VQ-VAE → UI Prior Training"
      breaks_at: "After VQ-VAE training completes in UI — no button/tab to launch prior training"
      requirements: ["GEN-01"]
tech_debt:
  - phase: 13-vq-vae-training-pipeline
    items:
      - "dead_codes vs dead_code_count key name discrepancy between UI and CLI codebook health display"
      - "TrainingRunner has no resume_vqvae() — resume button hidden in UI"
      - "save_vqvae_checkpoint / load_vqvae_checkpoint exported but not consumed by TrainingRunner"
  - phase: 14-autoregressive-prior
    items:
      - "unflatten_codes exported but unused — deferred to Phase 15 generation pipeline"
---

# Milestone v1.1 VQ-VAE — Audit Report

**Audited:** 2026-02-22
**Status:** gaps_found (milestone in progress — 3 of 7 phases complete)

## Executive Summary

Milestone v1.1 "VQ-VAE" is **in progress** with phases 12-14 complete and phases 15-18 not started. The completed work is solid — all 15 requirements assigned to phases 12-14 are verified as satisfied with zero critical gaps. Cross-phase integration across completed phases is clean (17/18 connections wired). The 19 remaining requirements are in unstarted phases (15-18) and represent planned remaining work, not failures.

**Key strength:** The foundational VQ-VAE pipeline is fully operational end-to-end via CLI: train VQ-VAE → save v2 model → train autoregressive prior → bundle prior into model file. All core architecture, training, persistence, and prior requirements are met.

## Scores

| Category | Score | Details |
|----------|-------|---------|
| Requirements | **15/34** | 15 satisfied (phases 12-14), 19 pending (phases 15-18) |
| Phases | **3/7** | Phases 12, 13, 14 passed; Phases 15-18 not started |
| Integration | **17/18** | 1 gap: no UI path to prior training (CLI only) |
| E2E Flows | **1/2** | CLI full pipeline works; UI prior training path absent |

## Phase Verification Summary

| Phase | Status | Score | Key Findings |
|-------|--------|-------|--------------|
| 12 - RVQ-VAE Core Architecture | **PASSED** | 4/4 truths | ConvVQVAE, adaptive codebook sizing, EMA+k-means, commitment loss all verified |
| 13 - VQ-VAE Training Pipeline | **PASSED** | 5/5 truths | Training loop, codebook health display, v2 persistence, UI/CLI controls verified |
| 14 - Autoregressive Prior | **PASSED** | 12/12 truths | CodePrior, train_prior, memorization detection, prior bundling, CLI — 1 gap found and resolved (commit 6bb0bb4) |
| 15 - Generation Pipeline | NOT STARTED | — | No plans, no implementation |
| 16 - Encode/Decode + Code Viz | NOT STARTED | — | No plans, no implementation |
| 17 - Code Editing | NOT STARTED | — | No plans, no implementation |
| 18 - Diagnostics + Library | NOT STARTED | — | No plans, no implementation |

## Requirements Coverage (3-Source Cross-Reference)

### Satisfied Requirements (15/34) — Phases 12-14

| REQ-ID | Description | Phase | VERIFICATION | REQUIREMENTS.md | Final |
|--------|-------------|-------|--------------|-----------------|-------|
| VQVAE-01 | RVQ-VAE training on small datasets | 12 | SATISFIED | [x] Complete | **satisfied** |
| VQVAE-02 | Auto-scaling codebook size (64/128/256) | 12 | SATISFIED | [x] Complete | **satisfied** |
| VQVAE-03 | EMA updates, k-means init, dead code reset | 12 | SATISFIED | [x] Complete | **satisfied** |
| VQVAE-04 | Per-level utilization/perplexity/dead codes displayed | 13 | SATISFIED | [x] Complete | **satisfied** |
| VQVAE-05 | Commitment loss (no KL divergence) | 12 | SATISFIED | [x] Complete | **satisfied** |
| VQVAE-06 | Configurable RVQ levels (2-4) and codebook dim | 12 | SATISFIED | [x] Complete | **satisfied** |
| VQVAE-07 | Low utilization warning at <30% | 13 | SATISFIED | [x] Complete | **satisfied** |
| GEN-01 | Train autoregressive prior on frozen codes | 14 | SATISFIED | [x] Complete | **satisfied** |
| GEN-05 | Prior bundled in saved model file | 14 | SATISFIED (gap resolved) | [x] Complete | **satisfied** |
| GEN-06 | Memorization detection | 14 | SATISFIED | [x] Complete | **satisfied** |
| PERS-01 | v2 format with codebook state | 13 | SATISFIED | [x] Complete | **satisfied** |
| PERS-02 | Prior state bundled in same file | 14 | SATISFIED (gap resolved) | [x] Complete | **satisfied** |
| UI-03 | Training tab VQ-VAE controls | 13 | SATISFIED | [x] Complete | **satisfied** |
| CLI-01 | CLI VQ-VAE training flags | 13 | SATISFIED | [x] Complete | **satisfied** |
| CLI-02 | CLI prior training command | 14 | SATISFIED | [x] Complete | **satisfied** |

**Note:** SUMMARY frontmatter lacks `requirements-completed` field for v1.1 phases — this is a documentation convention gap, not an implementation gap. Both VERIFICATION.md and REQUIREMENTS.md independently confirm completion.

### Unsatisfied Requirements (19/34) — Phases 15-18 (Not Started)

| Phase | Requirements | Count |
|-------|-------------|-------|
| Phase 15 (Generation Pipeline) | GEN-02, GEN-03, GEN-04, UI-04, CLI-04 | 5 |
| Phase 16 (Encode/Decode + Code Viz) | CODE-01, CODE-02, CODE-03, CODE-07, CODE-09 | 5 |
| Phase 17 (Code Editing) | CODE-04, CODE-05, CODE-06, CODE-08, UI-01 | 5 |
| Phase 18 (Diagnostics + Library) | PERS-03, UI-02, UI-05, CLI-03 | 4 |

All 19 are in phases that have not been planned or started. No orphaned requirements — all are mapped in the traceability table.

## Cross-Phase Integration

**17/18 connections wired** across completed phases (12-14).

### Verified Connections

| Connection | From → To | Status |
|-----------|-----------|--------|
| ConvVQVAE consumed by training loop | Phase 12 → Phase 13 | WIRED |
| VQVAEConfig flow (UI/CLI → model) | Phase 12 → Phase 13 | WIRED |
| vqvae_loss called in training step | Phase 12 → Phase 13 | WIRED |
| QuantizerWrapper health → VQEpochMetrics | Phase 12 → Phase 13 | WIRED |
| save_model_v2 output → load_model_v2 input | Phase 13 → Phase 14 | WIRED |
| ConvVQVAE.forward() → extract_code_sequences() | Phase 12 → Phase 14 | WIRED |
| VQVAEConfig → PriorConfig (model sizing) | Phase 12 → Phase 14 | WIRED |
| save_prior_to_model → load_model_v2 prior reconstruction | Phase 14 roundtrip | WIRED |
| CLI train-prior → save_prior_to_model | Phase 14 → Phase 14 | WIRED |
| VQEpochMetrics → UI codebook health table | Phase 13 internal | WIRED |
| VQEpochMetrics → CLI callback | Phase 13 internal | WIRED |
| PriorEpochMetrics → CLI perplexity display | Phase 14 internal | WIRED |
| memorization detection → CLI warnings | Phase 14 internal | WIRED |
| v1.0 backward compatibility preserved | All phases | WIRED |

### Integration Gap

| Gap | Impact | Requirements |
|-----|--------|-------------|
| No UI path to prior training | Users who train VQ-VAE via UI must switch to CLI for prior training | GEN-01 (partial — CLI works, UI deferred to future phases) |

## E2E Flow Verification

### Flow 1: CLI Full Pipeline — COMPLETE

```
distill train DATASET_DIR --rvq-levels 3
  → VQ-VAE trains with codebook health display
  → auto-saves as v2 .distill file
distill train-prior MODEL_PATH DATASET_DIR
  → loads v2 model, freezes VQ-VAE
  → extracts code sequences via ConvVQVAE.forward()
  → trains CodePrior with memorization detection
  → bundles prior into same .distill file
load_model_v2(MODEL_PATH)
  → reconstructs ConvVQVAE + CodePrior from single file
```

All steps verified and wired.

### Flow 2: UI VQ-VAE → UI Prior Training — BROKEN

User trains VQ-VAE via Gradio train tab → model saved → **break: no UI control for prior training** → must switch to CLI for `distill train-prior`.

`TrainingRunner` has `start_vqvae()` but no `start_prior()`. This is by design — UI prior training was deferred to future phases.

## Tech Debt

| Phase | Item | Severity |
|-------|------|----------|
| 13 | `dead_codes` vs `dead_code_count` key name discrepancy between UI and CLI health display | Low |
| 13 | TrainingRunner has no `resume_vqvae()` — resume button hidden in UI | Low |
| 13 | `save_vqvae_checkpoint` / `load_vqvae_checkpoint` exported but not consumed by runner | Info |
| 14 | `unflatten_codes` exported but unused — deferred to Phase 15 | Info |

**Total: 4 items across 2 phases. No blockers.**

## Completed Phases Detail

### Phase 12: RVQ-VAE Core Architecture — PASSED

- **4/4 success criteria** verified
- **5/5 requirements** satisfied (VQVAE-01, 02, 03, 05, 06)
- ConvVQVAE (548 lines) with QuantizerWrapper around ResidualVQ
- VQVAEConfig (21 fields) with get_adaptive_vqvae_config (3-tier sizing)
- vqvae_loss + multi_scale_mel_loss (no KL, no free bits, no annealing)
- No anti-patterns, no gaps

### Phase 13: VQ-VAE Training Pipeline — PASSED

- **5/5 success criteria** verified
- **5/5 requirements** satisfied (VQVAE-04, 07, PERS-01, UI-03, CLI-01)
- train_vqvae loop (730 lines), VQ metrics, codebook health monitoring
- v2 persistence (save_model_v2 / load_model_v2 / LoadedVQModel)
- Gradio VQ controls (RVQ levels slider, commitment weight, codebook size display)
- CLI flags (--codebook-size, --rvq-levels, --commitment-weight)
- 2 low-severity tech debt items

### Phase 14: Autoregressive Prior — PASSED

- **12/12 must-haves** verified (1 gap found and resolved in commit 6bb0bb4)
- **5/5 requirements** satisfied (GEN-01, 05, 06, PERS-02, CLI-02)
- CodePrior transformer (258 lines), flatten/unflatten utilities
- PriorConfig with adaptive sizing (3-tier: 128h/256h/512h)
- train_prior orchestrator (685 lines) with cross-entropy loss
- Memorization detection with adaptive thresholds (2.0/3.0/5.0)
- save_prior_to_model atomic bundling, prior reconstruction on load
- CLI train-prior command (257 lines) with Rich, SIGINT handling
- 1 info-level tech debt item

---

*Audit completed: 2026-02-22*
*Auditor: Claude (gsd-audit-milestone)*
