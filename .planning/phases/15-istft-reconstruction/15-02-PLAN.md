---
phase: 15-istft-reconstruction
plan: 02
type: execute
wave: 2
depends_on: [15-01]
files_modified:
  - src/distill/audio/spectrogram.py
  - src/distill/audio/filters.py
  - src/distill/inference/chunking.py
  - src/distill/inference/generation.py
  - src/distill/controls/analyzer.py
  - src/distill/training/preview.py
  - src/distill/training/loop.py
autonomous: true
requirements: [RECON-03]

must_haves:
  truths:
    - "No Griffin-Lim code exists anywhere in the codebase"
    - "No InverseMelScale usage remains in AudioSpectrogram (it was only needed for Griffin-Lim)"
    - "AudioSpectrogram.mel_to_waveform is removed -- it was the Griffin-Lim reconstruction path"
    - "All comments and docstrings referencing Griffin-Lim are updated or removed"
    - "Functional mel_to_waveform calls in analyzer.py and generation.py are replaced with TODO/Phase 16 comments"
  artifacts:
    - path: "src/distill/audio/spectrogram.py"
      provides: "AudioSpectrogram without Griffin-Lim/InverseMelScale, ComplexSpectrogram unchanged"
      contains: "class AudioSpectrogram"
    - path: "src/distill/audio/filters.py"
      provides: "Filters module with updated docstring (no Griffin-Lim references)"
    - path: "src/distill/inference/chunking.py"
      provides: "Chunking module with updated docstrings (no Griffin-Lim references)"
    - path: "src/distill/inference/generation.py"
      provides: "Generation module with mel_to_waveform call replaced by TODO/Phase 16 comment"
    - path: "src/distill/controls/analyzer.py"
      provides: "Analyzer module with mel_to_waveform call replaced by TODO/Phase 16 comment"
    - path: "src/distill/training/preview.py"
      provides: "Preview module with updated docstrings (no Griffin-Lim references)"
  key_links:
    - from: "src/distill/audio/spectrogram.py"
      to: "torchaudio.transforms"
      via: "AudioSpectrogram no longer imports GriffinLim or InverseMelScale"
      pattern: "MelSpectrogram"
---

<objective>
Remove all Griffin-Lim code, v1.0-only reconstruction paths, and related references from the entire codebase.

Purpose: Per user decision, Griffin-Lim is being fully deleted -- no debug flag, no fallback, no stub. This is a clean break to v2.0 ISTFT-only pipeline. Natural Python errors will surface any remaining references.

Output: Codebase with zero Griffin-Lim references, clean v2.0-only reconstruction
</objective>

<execution_context>
@C:/Users/Taylor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Taylor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-istft-reconstruction/15-CONTEXT.md
@.planning/phases/15-istft-reconstruction/15-01-SUMMARY.md

Key files to modify:
@src/distill/audio/spectrogram.py — AudioSpectrogram class with griffin_lim, inverse_mel, mel_to_waveform
@src/distill/audio/filters.py — docstring references GriffinLim (line 5)
@src/distill/inference/chunking.py — docstrings reference Griffin-Lim
@src/distill/inference/generation.py — functional call to spectrogram.mel_to_waveform (line 339)
@src/distill/controls/analyzer.py — functional call to spectrogram.mel_to_waveform (line 311)
@src/distill/training/preview.py — docstrings reference GriffinLim + InverseMelScale
@src/distill/training/loop.py — comment about Griffin-Lim preview
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove Griffin-Lim from AudioSpectrogram and clean all references</name>
  <files>
    src/distill/audio/spectrogram.py
    src/distill/audio/filters.py
    src/distill/inference/chunking.py
    src/distill/inference/generation.py
    src/distill/controls/analyzer.py
    src/distill/training/preview.py
    src/distill/training/loop.py
  </files>
  <action>
**In `src/distill/audio/spectrogram.py`:**

1. In `AudioSpectrogram.__init__`: Remove the `GriffinLim` and `InverseMelScale` imports from the torchaudio.transforms import line. Remove `self.inverse_mel` and `self.griffin_lim` instance attribute assignments. Keep `MelSpectrogram` import and `self.mel_transform`.

2. Remove the entire `mel_to_waveform` method from AudioSpectrogram. This was the v1.0 Griffin-Lim reconstruction path.

3. Update the `to()` method docstring: remove the line about `inverse_mel` and `griffin_lim` remaining on CPU.

4. Update the module-level docstring at the top of the file: remove the line about `InverseMelScale runs on CPU to avoid torch.linalg.lstsq issues on MPS` and the `GriffinLim` reference. Keep the v2.0 ComplexSpectrogram description. Update the description to reflect that AudioSpectrogram is now forward-only (waveform-to-mel) and ComplexSpectrogram handles both directions.

**In `src/distill/inference/chunking.py`:**

1. Update the module-level docstring: replace "before a single Griffin-Lim pass" with "before ISTFT reconstruction" or similar. Remove the line "A single Griffin-Lim pass on this mel reconstructs phase over the entire spectrogram, eliminating clicks entirely." Replace with a note about overlap-add mel synthesis for continuous audio.

2. Update `synthesize_continuous_mel` docstring: remove the Griffin-Lim reference in the docstring body.

3. Remove references to `spectrogram.mel_to_waveform` pattern mention if any in comments (the actual calls `spectrogram.mel_to_waveform` in `generate_chunks_crossfade` and `generate_chunks_latent_interp` stay for now -- Phase 16 will wire these to the v2.0 path; this phase only removes Griffin-Lim code and cleans references).

**In `src/distill/training/preview.py`:**

1. Update the module-level docstring: remove "InverseMelScale + GriffinLim run on CPU (project pattern from audio/spectrogram.py)." Update to reflect v2.0 reconstruction.

2. In `generate_preview` docstring: replace "via spectrogram.mel_to_waveform (CPU-based InverseMelScale + GriffinLim)" with just "via spectrogram reconstruction" or remove the parenthetical.

**In `src/distill/training/loop.py`:**

1. Remove the comment block at line ~690: "# NOTE: Preview generation uses GriffinLim (v1.0 single-channel) # which is not compatible with 2-channel models. Phase 15 will # replace this with ISTFT-based preview. For now, gracefully skip." Replace with a simple comment like "# Preview generation" (the graceful skip try/except should stay since it's still useful for error handling).

**In `src/distill/audio/filters.py`:**

1. Line 5 has a docstring referencing "Used after GriffinLim output". Update this docstring to remove the GriffinLim reference — replace with a neutral description like "Used after audio reconstruction" or similar.

**In `src/distill/controls/analyzer.py`:**

1. Line 311 has a functional call `spectrogram.mel_to_waveform(...)`. This call site will break once `mel_to_waveform` is removed from AudioSpectrogram. Do NOT delete the call (that would break the control flow). Instead, comment out the call and add a TODO comment: `# TODO(Phase 16): Replace mel_to_waveform with complex_mel_to_waveform ISTFT path`. Ensure the surrounding code handles the missing waveform gracefully (e.g., set `wav = None` or skip the waveform-dependent block with a comment).

**In `src/distill/inference/generation.py`:**

1. Line 339 has a functional call `spectrogram.mel_to_waveform(...)`. Same treatment as analyzer.py: comment out the call and add a TODO comment: `# TODO(Phase 16): Replace mel_to_waveform with complex_mel_to_waveform ISTFT path`. Ensure surrounding code handles the missing waveform gracefully.

**After all edits**, do a final grep for `griffin|Griffin|GRIFFIN|griffin_lim|GriffinLim` across the entire `src/` directory. If any references remain, clean them too. The goal is ZERO references to Griffin-Lim in the source code (test files are separate -- old tests were already deleted per CONTEXT.md decision). Also grep for `mel_to_waveform` -- the only remaining hits should be TODO comments in analyzer.py and generation.py, not live code calls.
  </action>
  <verify>
Run: `grep -ri "griffin\|GriffinLim\|griffin_lim" src/ --include="*.py"` -- must return ZERO results.
Run: `grep -ri "InverseMelScale" src/ --include="*.py"` -- only hit should be ComplexSpectrogram's `_inverse_mel = InverseMelScale(...)` in spectrogram.py (this is the ISTFT path, NOT Griffin-Lim; it is expected and correct).
Run: `grep -ri "mel_to_waveform" src/ --include="*.py"` -- must return ZERO results (removed from AudioSpectrogram; functional calls in analyzer.py and generation.py replaced with TODO comments).
Run: `python -c "from distill.audio.spectrogram import AudioSpectrogram, ComplexSpectrogram; print('imports OK')"` -- no import errors.
Run: `python -m pytest tests/test_istft_reconstruction.py -v` -- existing ISTFT tests still pass (ComplexSpectrogram unchanged).
  </verify>
  <done>Zero Griffin-Lim references in src/. AudioSpectrogram no longer has mel_to_waveform, griffin_lim, or inverse_mel. InverseMelScale only exists in ComplexSpectrogram (ISTFT path). Functional mel_to_waveform calls replaced with TODO/Phase 16 comments. All docstrings/comments updated. ISTFT tests still pass.</done>
</task>

</tasks>

<verification>
1. `grep -ri "griffin\|GriffinLim\|griffin_lim" src/ --include="*.py"` -- zero results
2. `grep -ri "InverseMelScale" src/ --include="*.py"` -- only hit is ComplexSpectrogram's `_inverse_mel = InverseMelScale(...)` in spectrogram.py (expected -- ISTFT path, not Griffin-Lim)
3. `grep -ri "mel_to_waveform" src/ --include="*.py"` -- only hits are TODO comments in analyzer.py and generation.py (no live code calls)
4. `python -c "from distill.audio.spectrogram import AudioSpectrogram; a = AudioSpectrogram(); assert not hasattr(a, 'griffin_lim'); assert not hasattr(a, 'mel_to_waveform'); print('PASS')"` -- confirms removal
5. `python -m pytest tests/test_istft_reconstruction.py -v` -- all tests still pass
</verification>

<success_criteria>
- Zero grep hits for "griffin" or "Griffin" or "griffin_lim" in src/ directory
- AudioSpectrogram class has no griffin_lim, no inverse_mel, no mel_to_waveform
- All comments and docstrings mentioning Griffin-Lim have been updated (including filters.py)
- Functional mel_to_waveform calls in analyzer.py and generation.py replaced with TODO/Phase 16 comments
- ComplexSpectrogram and its ISTFT reconstruction are unaffected (InverseMelScale in ComplexSpectrogram is expected)
- No import errors when importing from distill.audio.spectrogram
</success_criteria>

<output>
After completion, create `.planning/phases/15-istft-reconstruction/15-02-SUMMARY.md`
</output>
