---
phase: 08-gradio-ui
plan: 05
type: execute
wave: 3
depends_on: ["08-02", "08-03", "08-04"]
files_modified:
  - src/small_dataset_audio/ui/tabs/generate_tab.py
  - src/small_dataset_audio/ui/app.py
  - src/small_dataset_audio/app.py
  - src/small_dataset_audio/ui/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can view generation history with waveform thumbnails on Generate tab"
    - "User can A/B compare two generations from history"
    - "History and A/B sections are collapsible accordions on Generate tab"
    - "Tabs show guided empty state messages when prerequisites are not met"
    - "Application entry point (sda command) launches the Gradio UI"
    - "All features from Phases 1-7 are accessible through the interface"
  artifacts:
    - path: "src/small_dataset_audio/ui/tabs/generate_tab.py"
      provides: "History accordion and A/B comparison section"
      contains: "History|ABComparison"
    - path: "src/small_dataset_audio/app.py"
      provides: "Updated entry point that launches Gradio UI"
      contains: "launch_ui"
  key_links:
    - from: "src/small_dataset_audio/ui/tabs/generate_tab.py"
      to: "small_dataset_audio.history"
      via: "GenerationHistory.list_entries, ABComparison"
      pattern: "GenerationHistory|ABComparison"
    - from: "src/small_dataset_audio/app.py"
      to: "src/small_dataset_audio/ui/__init__.py"
      via: "launch_ui import and call"
      pattern: "launch_ui"
---

<objective>
Add generation history browsing and A/B comparison to the Generate tab as collapsible accordions, implement guided navigation empty states across all tabs, and wire the main application entry point to launch the Gradio UI.

Purpose: Complete the UI by adding the remaining user workflow features (history, A/B) and connecting the application's existing entry point to the new Gradio interface, making all Phases 1-7 accessible through the browser.

Output: Complete, launchable Gradio application with all features accessible.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-gradio-ui/08-RESEARCH.md
@.planning/phases/08-gradio-ui/08-01-SUMMARY.md
@.planning/phases/08-gradio-ui/08-02-SUMMARY.md
@.planning/phases/08-gradio-ui/08-03-SUMMARY.md
@.planning/phases/08-gradio-ui/08-04-SUMMARY.md
@src/small_dataset_audio/history/__init__.py
@src/small_dataset_audio/history/store.py
@src/small_dataset_audio/history/comparison.py
@src/small_dataset_audio/ui/tabs/generate_tab.py
@src/small_dataset_audio/ui/app.py
@src/small_dataset_audio/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add history accordion and A/B comparison to Generate tab</name>
  <files>
    src/small_dataset_audio/ui/tabs/generate_tab.py
  </files>
  <action>
1. Add a **History accordion** section to `build_generate_tab()` (per discretion recommendation: collapsible with gr.Accordion):
   - `gr.Accordion("Generation History", open=False)` containing:
     - `gr.Gallery(label="History", columns=4, height=300, visible=True)` showing waveform thumbnails of past generations
     - Each gallery item: thumbnail image with caption showing seed and timestamp
     - `gr.Button("Refresh History", size="sm")` to reload entries
     - `gr.Audio(label="History Playback", visible=False)` for playing selected history entry
   - **Handler `refresh_history()`**:
     - Call `app_state.history_store.list_entries(limit=20)` if history_store exists
     - Build gallery items: list of (thumbnail_path, caption) tuples
     - Return gallery update
   - **Handler `play_history_entry(evt: gr.SelectData)`**:
     - Get entry at selected index
     - Return audio file path to History Playback audio component
   - Wire: gallery .select -> play_history_entry, refresh button .click -> refresh_history
   - Auto-refresh: after each generation, also refresh the history gallery

2. Add an **A/B Comparison accordion** section below history:
   - `gr.Accordion("A/B Comparison", open=False)` containing:
     - `gr.Markdown("Select two generations from history to compare.")` instruction
     - `gr.Row` with two `gr.Dropdown` for selecting Entry A and Entry B (choices populated from history entries)
     - `gr.Button("Compare", variant="primary")`
     - `gr.Row` with:
       - `gr.Column`: `gr.Markdown("**A**")`, `gr.Audio(label="Generation A", visible=False)`
       - `gr.Column`: `gr.Markdown("**B**")`, `gr.Audio(label="Generation B", visible=False)`
     - `gr.Row` with `gr.Button("Keep A as Preset")` and `gr.Button("Keep B as Preset")`
   - **Handler `start_comparison(entry_a_name, entry_b_name)`**:
     - Find entry IDs from names
     - Create `ABComparison.from_two_entries(entry_a_id, entry_b_id)`
     - Set `app_state.ab_comparison = comparison`
     - Get audio paths via `comparison.get_audio_paths(app_state.history_store)`
     - Return: audio_a path, audio_b path, show both audio components
   - **Handler `keep_winner(side: str)`**:
     - If side == "A": winner entry ID is comparison.entry_a_id
     - If side == "B": winner entry ID is comparison.entry_b_id
     - Get the entry and save its slider positions as a preset via `app_state.ab_comparison.keep_winner(side, app_state.preset_manager, app_state.history_store)`
     - Return success message
   - **Handler `update_comparison_choices()`**:
     - Populate A/B dropdown choices from history entries
     - Called on accordion open and after history refresh
   - Wire: Compare button .click -> start_comparison, Keep A .click -> keep_winner("a"), Keep B .click -> keep_winner("b")

3. Ensure the generation handler (`generate_audio`) in this file also:
   - Adds the generation to history via `app_state.history_store.add_entry()` after successful generation
   - Auto-refreshes the history gallery after generation
   - Updates A/B comparison dropdown choices
  </action>
  <verify>Run `uv run python -c "from small_dataset_audio.ui.tabs.generate_tab import build_generate_tab; print('Generate tab with history/AB OK')"` to verify import still works after additions.</verify>
  <done>Generate tab includes collapsible History accordion with thumbnail gallery and playback, and collapsible A/B Comparison accordion with dual audio players and keep-winner preset save.</done>
</task>

<task type="auto">
  <name>Task 2: Wire guided navigation across tabs and update app entry point to launch Gradio UI</name>
  <files>
    src/small_dataset_audio/ui/app.py
    src/small_dataset_audio/app.py
    src/small_dataset_audio/ui/__init__.py
  </files>
  <action>
1. Update `src/small_dataset_audio/ui/app.py` guided navigation:
   - Each tab should react to state changes from other tabs. Since Gradio Blocks allows cross-tab component updates:
   - After Data tab import completes: update Train tab to show training controls (hide empty state, show config)
   - After Library tab loads a model: update Generate tab to show controls (hide empty state, show sliders)
   - After training completes: update Library tab save section
   - Implementation: use `.then()` chaining or `gr.on()` to trigger cross-tab visibility updates after key actions
   - The Data tab's upload handler should return additional outputs that update the Train tab's empty state visibility
   - The Library tab's load handler should return additional outputs that update the Generate tab's empty state visibility and slider configuration

2. Update `src/small_dataset_audio/app.py` (the main application entry point):
   - Keep existing CLI parsing (--device, --verbose, --benchmark, --config)
   - After startup validation and device selection, instead of just printing "ready", call `launch_ui()` from ui module
   - The flow: parse args -> first run check -> validate env -> select device -> launch_ui()
   - Pass the loaded config and selected device to `launch_ui()` so it can initialize AppState
   - Update `launch_ui()` signature in ui/__init__.py and ui/app.py to accept optional config and device parameters
   - Keep --benchmark mode as-is (runs benchmark and exits, does not launch UI)

3. Update `src/small_dataset_audio/ui/__init__.py`:
   - Update `launch_ui` signature to accept `config: dict | None = None, device=None`
   - If config/device provided, pass to init_state; otherwise load fresh

4. Final integration check: the `sda` console script entry point should now launch the full Gradio UI.
  </action>
  <verify>Run `uv run python -c "from small_dataset_audio.app import main; print('Entry point imports UI')"` to verify import chain. Run `uv run python -c "from small_dataset_audio.ui import launch_ui; print('launch_ui accepts config/device')"` to verify signature.</verify>
  <done>All tabs have guided navigation with appropriate empty states. Application entry point (sda command / python -m small_dataset_audio) launches the Gradio UI after startup validation. All features from Phases 1-7 are accessible through the browser interface.</done>
</task>

</tasks>

<verification>
1. `uv run python -c "from small_dataset_audio.ui.tabs.generate_tab import build_generate_tab; print('OK')"` succeeds with history/AB additions
2. `uv run python -c "from small_dataset_audio.ui.app import create_app; app = create_app(); print('Complete app built')"` succeeds
3. `uv run python -c "from small_dataset_audio.app import main"` succeeds (entry point imports UI)
4. History accordion uses gr.Gallery for thumbnail browsing
5. A/B comparison uses two gr.Audio components with keep-winner buttons
6. Cross-tab guided navigation: importing data enables Train tab, loading model enables Generate tab
7. sda console script launches Gradio UI after environment validation
</verification>

<success_criteria>
- Generation History accordion on Generate tab shows waveform thumbnails
- Clicking history thumbnail plays that generation
- A/B Comparison accordion allows selecting two entries and comparing side-by-side
- Keep Winner buttons save winning generation's parameters as a preset
- Empty state messages guide users to the right tab when prerequisites are missing
- `sda` command launches the full Gradio UI in a browser
- All features from Phases 1-7 (import, train, generate, sliders, export, presets, history, A/B, model library) accessible through the interface
</success_criteria>

<output>
After completion, create `.planning/phases/08-gradio-ui/08-05-SUMMARY.md`
</output>
