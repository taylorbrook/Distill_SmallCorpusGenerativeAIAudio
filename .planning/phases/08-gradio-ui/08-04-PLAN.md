---
phase: 08-gradio-ui
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/small_dataset_audio/ui/tabs/library_tab.py
  - src/small_dataset_audio/ui/components/model_card.py
  - src/small_dataset_audio/ui/app.py
autonomous: true

must_haves:
  truths:
    - "User can browse saved models in a card grid view"
    - "User can switch to a sortable table view"
    - "Card grid shows name, dataset info, training date, sample count per card"
    - "User can load a model from the library to start generating"
    - "User can delete a model from the library"
    - "User can save a newly trained model to the library"
  artifacts:
    - path: "src/small_dataset_audio/ui/tabs/library_tab.py"
      provides: "Library tab with card grid, table view, model management"
      contains: "def build_library_tab"
    - path: "src/small_dataset_audio/ui/components/model_card.py"
      provides: "HTML template for model card grid"
      contains: "def render_model_cards"
  key_links:
    - from: "src/small_dataset_audio/ui/tabs/library_tab.py"
      to: "small_dataset_audio.library"
      via: "ModelLibrary.list_models, ModelLibrary.search"
      pattern: "ModelLibrary|ModelEntry"
    - from: "src/small_dataset_audio/ui/tabs/library_tab.py"
      to: "small_dataset_audio.models"
      via: "load_model, delete_model, save_model_from_checkpoint"
      pattern: "load_model|delete_model|save_model"
    - from: "src/small_dataset_audio/ui/tabs/library_tab.py"
      to: "src/small_dataset_audio/ui/state.py"
      via: "app_state.loaded_model, pipeline, preset_manager, history_store"
      pattern: "app_state"
---

<objective>
Build the Library tab with dual-view model browsing (card grid default + sortable table toggle), model loading for generation, model deletion, and saving trained models to the library.

Purpose: Users need to manage their trained models -- browse, load for generation, and maintain their model collection. The dual-view satisfies both visual browsing (cards) and efficient scanning (table).

Output: Library tab with card grid, table view toggle, load/delete/save model actions.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-gradio-ui/08-RESEARCH.md
@.planning/phases/08-gradio-ui/08-01-SUMMARY.md
@.planning/phases/06-model-persistence-management/06-01-SUMMARY.md
@src/small_dataset_audio/library/__init__.py
@src/small_dataset_audio/library/catalog.py
@src/small_dataset_audio/models/__init__.py
@src/small_dataset_audio/models/persistence.py
@src/small_dataset_audio/ui/state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create model card HTML renderer and Library tab with dual view and model management</name>
  <files>
    src/small_dataset_audio/ui/components/model_card.py
    src/small_dataset_audio/ui/tabs/library_tab.py
  </files>
  <action>
1. Create `src/small_dataset_audio/ui/components/model_card.py`:
   - `render_model_cards(models: list[ModelEntry]) -> str`:
     - Returns HTML string with responsive grid layout using CSS grid
     - Grid: `display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;`
     - Each card: border, rounded corners, padding, hover shadow effect
     - Card content: model name (h3), dataset name + file count, training date (formatted nicely), epoch count, component count
     - Each card has a unique `data-model-id` attribute for identification
     - Returns "No models in library yet." message if list is empty
   - `render_single_card(model: ModelEntry) -> str`: helper for one card

2. Create `src/small_dataset_audio/ui/tabs/library_tab.py` with `build_library_tab()`:

   **Empty state**: `gr.Markdown` from guided_nav for "library" -- shown when library is empty.

   **Header section**:
   - `gr.Markdown("## Model Library")`
   - `gr.Row` with:
     - `gr.Textbox(label="Search", placeholder="Search models...", scale=3)` for search/filter
     - `gr.Radio(choices=["Cards", "Table"], value="Cards", label="View")` for view toggle

   **Save model section**:
   - `gr.Accordion("Save Current Model", open=False)`:
     - `gr.Textbox(label="Model Name", placeholder="My Model")`
     - `gr.Textbox(label="Description", placeholder="Optional description", lines=2)`
     - `gr.Textbox(label="Tags", placeholder="ambient, texture, pad (comma-separated)")`
     - `gr.Button("Save to Library", variant="primary")`
   - This is for saving after training completes -- calls `save_model_from_checkpoint()` then adds to library

   **Card grid view** (visible=True by default, per locked decision):
   - `gr.HTML` component displaying the card grid from `render_model_cards()`
   - Below cards: `gr.Row` with `gr.Dropdown(label="Select Model", choices=[])` for model selection (since gr.HTML click events are limited per RESEARCH.md open question #2)
   - `gr.Button("Load Selected", variant="primary")` and `gr.Button("Delete Selected", variant="stop")`

   **Table view** (visible=False, shown on toggle):
   - `gr.Dataframe` with columns: Name, Dataset, Files, Epochs, Date, Components
   - Sortable columns (Dataframe provides this natively)
   - Row selection for load/delete actions
   - Same Load/Delete buttons shared with card view

   **Handlers**:

   `refresh_library()`:
   - Gets all models from `app_state.model_library.list_models()` (or search results)
   - Updates card grid HTML via `render_model_cards(models)`
   - Updates table Dataframe with model data
   - Updates Select Model dropdown choices
   - Returns: card_html, table_data, dropdown_choices

   `toggle_view(view_choice)`:
   - "Cards": show card grid, hide table
   - "Table": hide card grid, show table
   - Return visibility updates

   `search_models(query)`:
   - Call `app_state.model_library.search(name=query)` if query not empty
   - Otherwise list all
   - Refresh both views

   `load_model_handler(selected_model_name)`:
   - Find model entry by name from library
   - Call `load_model(model_path)` to get LoadedModel
   - Set `app_state.loaded_model = loaded_model`
   - Create `GenerationPipeline` from loaded model and set `app_state.pipeline`
   - Create `PresetManager(model_id)` and set `app_state.preset_manager`
   - Create `GenerationHistory(model_id)` and set `app_state.history_store`
   - Return status message "Model loaded: {name}"
   - NOTE: This handler must also trigger slider updates on Generate tab -- return a signal that Generate tab can react to (use gr.State or return updates to slider components if they are accessible)

   `delete_model_handler(selected_model_name)`:
   - Find model entry by name
   - Call `delete_model(model_path, app_state.model_library)`
   - Refresh library views
   - Return status message

   `save_model_handler(name, description, tags_str)`:
   - Validate: training must have completed (check app_state.training_runner.result)
   - Get checkpoint path from training result
   - Call `save_model_from_checkpoint(checkpoint_path, name, description, tags)`
   - Add to library via `app_state.model_library`
   - Refresh library views
   - Return status message

   Wire: search textbox .change -> search_models, radio .change -> toggle_view, Load button .click -> load_model_handler, Delete button .click -> delete_model_handler, Save button .click -> save_model_handler
  </action>
  <verify>Run `uv run python -c "from small_dataset_audio.ui.tabs.library_tab import build_library_tab; print('Library tab OK')"` and `uv run python -c "from small_dataset_audio.ui.components.model_card import render_model_cards; print(len(render_model_cards([])))"` to verify imports.</verify>
  <done>Library tab has card grid view (default) and sortable table view with toggle. Search field filters models. Load/Delete buttons manage models. Save accordion allows saving trained models with name/description/tags.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Library tab into app.py and verify integration</name>
  <files>
    src/small_dataset_audio/ui/app.py
  </files>
  <action>
1. Update `src/small_dataset_audio/ui/app.py`:
   - Import `build_library_tab` from `small_dataset_audio.ui.tabs.library_tab`
   - Replace the Library tab placeholder with `build_library_tab()` call

2. The Library tab's `load_model_handler` needs to trigger slider updates on the Generate tab. Since all components are within the same gr.Blocks scope, the load handler can return updates to Generate tab slider components. To achieve this:
   - In `create_app()`, after building all tabs, wire a cross-tab event: the Library's Load button click should also output to the Generate tab's slider components
   - This requires the Generate tab's `build_generate_tab()` to return references to its slider components
   - Update `build_generate_tab()` in generate_tab.py to return the slider component list so app.py can wire cross-tab updates
   - Update `build_library_tab()` to return the Load button component for cross-tab wiring
   - In app.py, wire: load_button.click -> load_and_update_sliders -> [sliders + generate_tab_visibility]

3. Verify the complete app builds with all 4 tabs functional.
  </action>
  <verify>Run `uv run python -c "from small_dataset_audio.ui.app import create_app; app = create_app(); print('Full 4-tab app built')"` to verify.</verify>
  <done>All 4 tabs wired into app.py. Library tab load action triggers slider updates on Generate tab. App builds successfully with complete tab structure.</done>
</task>

</tasks>

<verification>
1. `uv run python -c "from small_dataset_audio.ui.components.model_card import render_model_cards; print('OK')"` succeeds
2. `uv run python -c "from small_dataset_audio.ui.tabs.library_tab import build_library_tab; print('OK')"` succeeds
3. `uv run python -c "from small_dataset_audio.ui.app import create_app; app = create_app(); print('OK')"` succeeds with all 4 tabs
4. Card grid HTML includes responsive CSS grid layout
5. Table view uses gr.Dataframe with sortable columns
6. Load model handler creates GenerationPipeline and sets app_state
7. Cross-tab wiring: loading a model updates Generate tab sliders
</verification>

<success_criteria>
- Card grid view (default) shows model cards with name, dataset, date, epochs, components
- Table view shows sortable columns with model metadata
- Toggle switches between card grid and table views
- Search field filters models in both views
- Load button loads model and sets up generation pipeline + preset manager + history store
- Delete button removes model from library and disk
- Save accordion allows saving trained models with metadata
- Loading a model from Library updates Generate tab sliders
</success_criteria>

<output>
After completion, create `.planning/phases/08-gradio-ui/08-04-SUMMARY.md`
</output>
