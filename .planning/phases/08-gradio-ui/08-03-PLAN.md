---
phase: 08-gradio-ui
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/small_dataset_audio/ui/tabs/generate_tab.py
  - src/small_dataset_audio/ui/app.py
autonomous: true

must_haves:
  truths:
    - "User can adjust musically meaningful parameter sliders grouped by category"
    - "User can click Generate to produce audio with spinner feedback"
    - "Inline audio player with waveform appears after generation (no auto-play)"
    - "Export controls (sample rate, bit depth, filename) sit next to the audio player"
    - "User can save/recall slider presets via dropdown"
    - "Seed field is visible with Randomize button for reproducibility"
  artifacts:
    - path: "src/small_dataset_audio/ui/tabs/generate_tab.py"
      provides: "Generate tab with sliders, generation, audio, export, presets"
      contains: "def build_generate_tab"
  key_links:
    - from: "src/small_dataset_audio/ui/tabs/generate_tab.py"
      to: "small_dataset_audio.inference"
      via: "GenerationPipeline.generate, export_wav"
      pattern: "GenerationPipeline|export_wav"
    - from: "src/small_dataset_audio/ui/tabs/generate_tab.py"
      to: "small_dataset_audio.controls"
      via: "get_slider_info, sliders_to_latent, SliderState"
      pattern: "sliders_to_latent|get_slider_info"
    - from: "src/small_dataset_audio/ui/tabs/generate_tab.py"
      to: "small_dataset_audio.presets"
      via: "PresetManager save/load/list"
      pattern: "PresetManager"
---

<objective>
Build the Generate tab with musically meaningful parameter sliders (grouped by category in columns), Generate button with progress feedback, inline audio player with waveform, export controls, preset dropdown for save/recall, and seed input.

Purpose: This is the core user interaction surface -- the generate-listen-export workflow. All slider controls map to the PCA-derived latent space from Phase 5.

Output: Fully functional Generate tab with slider-controlled audio generation, playback, export, and preset management.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-gradio-ui/08-RESEARCH.md
@.planning/phases/08-gradio-ui/08-01-SUMMARY.md
@src/small_dataset_audio/controls/__init__.py
@src/small_dataset_audio/controls/mapping.py
@src/small_dataset_audio/inference/__init__.py
@src/small_dataset_audio/inference/generation.py
@src/small_dataset_audio/inference/export.py
@src/small_dataset_audio/presets/__init__.py
@src/small_dataset_audio/ui/state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Generate tab with sliders, generation, audio player, export, and presets</name>
  <files>
    src/small_dataset_audio/ui/tabs/generate_tab.py
  </files>
  <action>
1. Create `src/small_dataset_audio/ui/tabs/generate_tab.py` with `build_generate_tab()`:

   **Constants**: `MAX_SLIDERS = 12` (max PCA components any model will have)

   **Empty state**: `gr.Markdown` with guided nav message for "generate" -- shown when no model loaded, hidden when model is loaded.

   **Controls section** (visible=False, shown when model loaded):

   **Slider section** -- grouped by category in 2-3 columns per locked decision:
   - `gr.Row` containing 2-3 `gr.Column` blocks
   - Pre-create `MAX_SLIDERS` `gr.Slider` components, distributed across columns:
     - Column 1: sliders 0-3 (timbral parameters typically)
     - Column 2: sliders 4-7 (temporal parameters typically)
     - Column 3: sliders 8-11 (spatial parameters typically)
   - Each slider: minimum=-10, maximum=10, value=0, step=1, label=f"Axis {i+1}", visible=False, interactive=True
   - Slider labels and visibility update dynamically when a model is loaded via `update_sliders_for_model()`
   - Use `get_slider_info(analysis)` to get labels, ranges, warning zones

   **Generation config row**:
   - `gr.Number` for duration_s (label="Duration (sec)", value=1.0, minimum=0.1, maximum=60.0)
   - `gr.Dropdown` for stereo_mode (choices=["mono", "mid_side", "dual_seed"], value="mono", label="Stereo Mode")
   - `gr.Slider` for stereo_width (0.0-1.5, step=0.1, value=0.7, label="Stereo Width", visible=False -- shown when stereo mode != mono)

   **Seed row**:
   - `gr.Number` for seed (label="Seed", value=None, precision=0) -- visible by default per discretion recommendation
   - `gr.Button("Randomize", size="sm")` next to seed field
   - Randomize sets seed to a random integer (use `random.randint(0, 2**31)`)

   **Generate button and progress**:
   - `gr.Button("Generate", variant="primary", size="lg")`
   - The Generate handler should show a progress indicator

   **Audio output section**:
   - `gr.Audio(label="Generated Audio", visible=False, type="numpy")` -- appears after generation with waveform display
   - Quality badge: `gr.Markdown` showing traffic light quality rating (green/yellow/red from compute_quality_score)

   **Export controls** (in a `gr.Row` next to audio player, per locked decision):
   - `gr.Dropdown` for export sample rate (choices=["44100", "48000", "96000"], value="48000", label="Sample Rate")
   - `gr.Dropdown` for export bit depth (choices=["16-bit", "24-bit", "32-bit float"], value="24-bit", label="Bit Depth")
   - `gr.Textbox` for filename (label="Filename", placeholder="auto-generated")
   - `gr.Button("Export WAV", variant="secondary")`

   **Preset section** (per discretion: dropdown with save/delete):
   - `gr.Row` with:
     - `gr.Dropdown(label="Preset", choices=["Custom"], value="Custom", filterable=True, allow_custom_value=False)`
     - `gr.Textbox(label="Preset Name", placeholder="My Preset", visible=False)` -- shown when saving
     - `gr.Button("Save Preset", size="sm")`
     - `gr.Button("Delete Preset", size="sm", variant="stop")`

   **Handlers**:

   `update_sliders_for_model()`:
   - Called when a model is loaded (from Library tab or state change)
   - Gets `get_slider_info(app_state.loaded_model.analysis)` for slider metadata
   - Returns visibility and label updates for all MAX_SLIDERS slots
   - Updates preset dropdown choices from `app_state.preset_manager.list_presets()`
   - Category grouping: use the `suggested_label` from get_slider_info. Labels containing "bright", "warm", "rough" go in column 1 (timbral); "rhythm", "pulse", "tempo" in column 2 (temporal); "space", "reverb", "dense" in column 3 (spatial); fallback to sequential distribution

   `generate_audio(*slider_values, duration, stereo_mode, stereo_width, seed)`:
   - Validate model loaded
   - Build SliderState from slider values (only first N where N = active components)
   - Convert to latent vector via `sliders_to_latent(slider_state, app_state.loaded_model.analysis)`
   - Build GenerationConfig with latent_vector, duration_s, stereo_mode, stereo_width, seed
   - Call `app_state.pipeline.generate(config)`
   - Get quality score via `compute_quality_score(result.audio, result.sample_rate)`
   - Store result in app_state for export
   - Add to history via `app_state.history_store.add_entry()` if history_store exists
   - Return: audio as (sample_rate, ndarray) tuple for gr.Audio, quality badge markdown, show audio component

   `export_audio(sample_rate_str, bit_depth, filename)`:
   - Get last generation result from app_state
   - Call `export_wav()` with configured sample rate, bit depth, output path
   - Return: file path for download or success message

   `save_preset(preset_name, *slider_values)`:
   - Call `app_state.preset_manager.save_preset(name, slider_positions=list(slider_values[:n_active]))`
   - Refresh preset dropdown choices
   - Return updated dropdown

   `load_preset(preset_name)`:
   - If "Custom", return no change
   - Call `app_state.preset_manager.load_preset(preset_name)`
   - Return slider value updates from preset positions

   `delete_preset(preset_name)`:
   - Call `app_state.preset_manager.delete_preset(preset_name)`
   - Refresh dropdown, reset to "Custom"

   `toggle_stereo_width(stereo_mode)`:
   - Return `gr.update(visible=(stereo_mode != "mono"))` for stereo_width slider

2. Wire all event handlers within `build_generate_tab()`.
  </action>
  <verify>Run `uv run python -c "from small_dataset_audio.ui.tabs.generate_tab import build_generate_tab, MAX_SLIDERS; print(f'Generate tab OK, {MAX_SLIDERS} max sliders')"` to verify import.</verify>
  <done>Generate tab has MAX_SLIDERS sliders grouped in 2-3 columns, Generate button, audio player with waveform, quality badge, export controls (sample rate, bit depth, filename, Export WAV button), preset dropdown with save/delete, seed field with Randomize button, and stereo mode controls.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Generate tab into app.py</name>
  <files>
    src/small_dataset_audio/ui/app.py
  </files>
  <action>
1. Update `src/small_dataset_audio/ui/app.py`:
   - Import `build_generate_tab` from `small_dataset_audio.ui.tabs.generate_tab`
   - Replace the Generate tab placeholder with `build_generate_tab()` call

2. Verify app builds correctly with all wired tabs so far.
  </action>
  <verify>Run `uv run python -c "from small_dataset_audio.ui.app import create_app; app = create_app(); print('App with generate tab built')"` to verify.</verify>
  <done>Generate tab wired into main app. App builds with Data, Train, and Generate tabs functional. Library tab still shows placeholder.</done>
</task>

</tasks>

<verification>
1. `uv run python -c "from small_dataset_audio.ui.tabs.generate_tab import build_generate_tab; print('OK')"` succeeds
2. Generate tab code creates MAX_SLIDERS=12 slider components distributed across columns
3. Generate handler builds SliderState -> sliders_to_latent -> GenerationConfig -> pipeline.generate
4. Export handler calls export_wav with user-selected sample rate and bit depth
5. Preset dropdown wired to PresetManager save/load/delete
6. Seed field visible with Randomize button
7. Audio output component uses type="numpy" for (sample_rate, ndarray) tuple
</verification>

<success_criteria>
- Sliders grouped by category in 2-3 columns, dynamic visibility based on loaded model
- Generate button triggers generation with progress feedback
- Audio player with waveform appears after generation (no auto-play)
- Quality badge shows traffic light rating
- Export controls (sample rate, bit depth, filename) next to audio player
- Preset dropdown supports save, load, and delete
- Seed input visible with Randomize button
- Stereo width control shown/hidden based on stereo mode
</success_criteria>

<output>
After completion, create `.planning/phases/08-gradio-ui/08-03-SUMMARY.md`
</output>
