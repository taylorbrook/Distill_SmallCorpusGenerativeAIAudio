---
phase: 08-gradio-ui
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/small_dataset_audio/ui/tabs/train_tab.py
  - src/small_dataset_audio/ui/components/loss_chart.py
  - src/small_dataset_audio/ui/app.py
autonomous: true

must_haves:
  truths:
    - "User can start training from the Train tab with configurable parameters"
    - "Live loss chart updates during training showing train and validation curves"
    - "Stats panel shows epoch, learning rate, and ETA during training"
    - "Inline audio players appear for each preview epoch"
    - "User can cancel training with a Cancel button"
    - "Resume Training button appears when a checkpoint exists for the dataset"
  artifacts:
    - path: "src/small_dataset_audio/ui/tabs/train_tab.py"
      provides: "Train tab with config, progress, previews, cancel/resume"
      contains: "def build_train_tab"
    - path: "src/small_dataset_audio/ui/components/loss_chart.py"
      provides: "matplotlib figure builder for training loss curves"
      contains: "def build_loss_chart"
  key_links:
    - from: "src/small_dataset_audio/ui/tabs/train_tab.py"
      to: "small_dataset_audio.training"
      via: "TrainingRunner.start, TrainingRunner.cancel"
      pattern: "TrainingRunner"
    - from: "src/small_dataset_audio/ui/tabs/train_tab.py"
      to: "src/small_dataset_audio/ui/components/loss_chart.py"
      via: "build_loss_chart called by Timer tick"
      pattern: "build_loss_chart"
    - from: "src/small_dataset_audio/ui/tabs/train_tab.py"
      to: "src/small_dataset_audio/ui/state.py"
      via: "app_state.training_runner, metrics_buffer"
      pattern: "app_state"
---

<objective>
Build the complete Train tab with training configuration UI, live loss chart via gr.Timer polling, training statistics panel, preview audio player progression, and cancel/resume controls.

Purpose: This is the most technically complex tab due to background thread + Timer polling. It surfaces the TrainingRunner (Phase 3) with live feedback.

Output: Fully functional Train tab with live training monitoring, preview playback, and cancel/resume.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-gradio-ui/08-RESEARCH.md
@.planning/phases/08-gradio-ui/08-01-SUMMARY.md
@src/small_dataset_audio/training/__init__.py
@src/small_dataset_audio/training/runner.py
@src/small_dataset_audio/training/config.py
@src/small_dataset_audio/training/metrics.py
@src/small_dataset_audio/training/preview.py
@src/small_dataset_audio/ui/state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create loss chart builder and Train tab with config, progress, previews, and cancel/resume</name>
  <files>
    src/small_dataset_audio/ui/components/loss_chart.py
    src/small_dataset_audio/ui/tabs/train_tab.py
  </files>
  <action>
1. Create `src/small_dataset_audio/ui/components/loss_chart.py`:
   - `import matplotlib; matplotlib.use("Agg")` at module top (headless, thread-safe)
   - `build_loss_chart(epoch_metrics: list) -> matplotlib.figure.Figure | None`:
     - Returns None if epoch_metrics is empty
     - Creates figure (8x4 inches) with dual y-axis or single axis
     - Plots train_loss and val_loss vs epoch as separate lines with labels
     - Sets xlabel "Epoch", ylabel "Loss", title "Training Progress", legend
     - Calls `plt.tight_layout()`
     - Returns the figure (do NOT call plt.show)
     - Close any prior figure to prevent memory leak: use `plt.figure()` then return, don't accumulate

2. Create `src/small_dataset_audio/ui/tabs/train_tab.py` with `build_train_tab()`:

   **Empty state**: Show guided nav message when no dataset is imported (check `app_state.current_dataset`). Use `gr.Markdown` with empty state from guided_nav.

   **Training config section** (per discretion recommendation: preset selector + smart defaults + advanced accordion):
   - `gr.Dropdown` for training preset: choices=["Conservative", "Balanced", "Aggressive"], value="Balanced", label="Training Preset"
   - `gr.Number` for max_epochs (label="Max Epochs", value=100)
   - `gr.Number` for learning_rate (label="Learning Rate", value=1e-3, precision=6)
   - `gr.Accordion("Advanced Training Settings", open=False)` containing:
     - `gr.Slider` for dropout (0.0-0.5, step=0.05, value=0.1)
     - `gr.Slider` for weight_decay (0.0-0.01, step=0.001, value=0.001)
     - `gr.Slider` for kl_weight_max (0.0-1.0, step=0.1, value=0.5)
   - When preset changes, auto-populate epochs/LR/advanced values from `get_adaptive_config(app_state.current_dataset.file_count if app_state.current_dataset else 10)` combined with OverfittingPreset mapping

   **Control buttons**:
   - `gr.Row` with:
     - `gr.Button("Train", variant="primary")` -- start button
     - `gr.Button("Cancel", variant="stop", interactive=False)` -- cancel button
     - `gr.Button("Resume Training", visible=False)` -- shown when checkpoint exists

   **Training dashboard** (visible when training is active):
   - `gr.Plot(label="Loss Curves")` for matplotlib loss chart
   - `gr.Markdown` for stats: "Epoch X/Y | LR: Z | ETA: Ns" (updated by timer)
   - `gr.Timer(value=2, active=False)` -- activated on train start, deactivated on complete/cancel

   **Preview audio section**:
   - Pre-create 20 `gr.Audio` components (visible=False, label="Epoch N"). These are shown progressively as previews arrive during training.
   - Each preview audio component gets `show_download_button=False` to keep compact

   **Training callback** (`_training_callback(event)`):
   - Stores events in `app_state.metrics_buffer`:
     - EpochMetrics -> append to `metrics_buffer["epoch_metrics"]`
     - PreviewEvent -> append to `metrics_buffer["previews"]`
     - TrainingCompleteEvent -> set `metrics_buffer["complete"] = True`
   - This callback is passed to TrainingRunner.start()

   **Timer tick handler** (`poll_training()`):
   - Reads `app_state.metrics_buffer`
   - Calls `build_loss_chart(metrics_buffer["epoch_metrics"])` for the plot
   - Builds stats string from latest EpochMetrics
   - Shows preview Audio components for each PreviewEvent (set visible=True, value=preview_path)
   - If `metrics_buffer["complete"]` is True: deactivate timer, re-enable Start button, disable Cancel, set `app_state.training_active = False`
   - Returns: [loss_plot, stats_text, timer_update] + [audio_updates for each preview slot]

   **Start handler** (`start_training(...)`):
   - Validate dataset exists
   - Build TrainingConfig from UI inputs using get_adaptive_config as base
   - Clear metrics buffer via `reset_metrics_buffer()`
   - Create TrainingRunner, store in app_state
   - Call `runner.start(config=config, file_paths=..., output_dir=..., device=app_state.device, callback=_training_callback)`
   - Set `app_state.training_active = True`
   - Return: activate timer, disable Start, enable Cancel, hide all preview audios

   **Cancel handler** (`cancel_training()`):
   - Call `app_state.training_runner.cancel()` if runner exists
   - Return: deactivate timer, enable Start, disable Cancel

   **Resume handler** (`resume_training()`):
   - Find latest checkpoint via `get_best_checkpoint()` or `list_checkpoints()` for the dataset output dir
   - Call TrainingRunner.start() with checkpoint_path for resume
   - Same timer/button updates as start

   **Resume visibility**: On tab render / dataset change, check if checkpoints exist in the dataset output dir. Show Resume button if so.
  </action>
  <verify>Run `uv run python -c "from small_dataset_audio.ui.tabs.train_tab import build_train_tab; print('Train tab OK')"` to verify import. Run `uv run python -c "from small_dataset_audio.ui.components.loss_chart import build_loss_chart; print(build_loss_chart([]))"` should print None.</verify>
  <done>Train tab has training config UI with preset selector and advanced accordion, Start/Cancel/Resume buttons, live loss chart via Timer polling, stats panel, and 20 pre-created preview audio slots that appear as training progresses.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Train tab into app.py and verify integration</name>
  <files>
    src/small_dataset_audio/ui/app.py
  </files>
  <action>
1. Update `src/small_dataset_audio/ui/app.py`:
   - Import `build_train_tab` from `small_dataset_audio.ui.tabs.train_tab`
   - Replace the Train tab placeholder `gr.Markdown` with `build_train_tab()` call
   - Ensure the Train tab still shows empty state guidance when no dataset is loaded (handled inside build_train_tab)

2. Verify the complete app still builds without error by importing create_app.
  </action>
  <verify>Run `uv run python -c "from small_dataset_audio.ui.app import create_app; app = create_app(); print('App with train tab built')"` to verify the app assembles correctly with the Train tab wired in.</verify>
  <done>Train tab is wired into the main app. App builds successfully with Data tab and Train tab both functional. Generate and Library tabs still show empty state placeholders.</done>
</task>

</tasks>

<verification>
1. `uv run python -c "from small_dataset_audio.ui.components.loss_chart import build_loss_chart; print(build_loss_chart([]))"` returns None
2. `uv run python -c "from small_dataset_audio.ui.tabs.train_tab import build_train_tab; print('OK')"` succeeds
3. `uv run python -c "from small_dataset_audio.ui.app import create_app; app = create_app(); print('App built')"` succeeds
4. Train tab code references TrainingRunner.start, TrainingRunner.cancel for training control
5. Timer is created with active=False and activated only on training start
6. 20 preview Audio components pre-created for progressive display
</verification>

<success_criteria>
- Train tab shows config UI with preset dropdown, epochs, learning rate, and advanced accordion
- Start/Cancel buttons control training lifecycle
- Resume button shown when checkpoint exists
- gr.Timer polls training metrics every 2 seconds
- Loss chart updates live with train and validation curves
- Stats panel shows epoch/LR/ETA
- Preview audio players appear progressively as training generates previews
- Timer deactivates when training completes or is cancelled
</success_criteria>

<output>
After completion, create `.planning/phases/08-gradio-ui/08-02-SUMMARY.md`
</output>
