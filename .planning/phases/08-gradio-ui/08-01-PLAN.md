---
phase: 08-gradio-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/small_dataset_audio/ui/__init__.py
  - src/small_dataset_audio/ui/app.py
  - src/small_dataset_audio/ui/state.py
  - src/small_dataset_audio/ui/tabs/__init__.py
  - src/small_dataset_audio/ui/tabs/data_tab.py
  - src/small_dataset_audio/ui/components/__init__.py
  - src/small_dataset_audio/ui/components/guided_nav.py
autonomous: true

must_haves:
  truths:
    - "Gradio dependency is installed and importable"
    - "Application launches a Gradio web UI accessible in a browser"
    - "Data tab allows drag-and-drop file upload and directory browse"
    - "Data tab shows stats panel after import (count, duration, rate)"
    - "Data tab displays waveform thumbnail grid after import"
    - "AppState singleton holds references to all backend objects"
  artifacts:
    - path: "pyproject.toml"
      provides: "gradio dependency declaration"
      contains: "gradio"
    - path: "src/small_dataset_audio/ui/app.py"
      provides: "gr.Blocks app assembly with 4-tab layout"
      contains: "gr.Tabs"
    - path: "src/small_dataset_audio/ui/state.py"
      provides: "AppState singleton for module-level state"
      contains: "class AppState"
    - path: "src/small_dataset_audio/ui/tabs/data_tab.py"
      provides: "Data tab with import, stats, thumbnails"
      contains: "def build_data_tab"
    - path: "src/small_dataset_audio/ui/components/guided_nav.py"
      provides: "Empty state messages for unready tabs"
      contains: "def get_empty_state_message"
  key_links:
    - from: "src/small_dataset_audio/ui/app.py"
      to: "src/small_dataset_audio/ui/tabs/data_tab.py"
      via: "build_data_tab import and call"
      pattern: "build_data_tab"
    - from: "src/small_dataset_audio/ui/tabs/data_tab.py"
      to: "small_dataset_audio.data"
      via: "Dataset.from_files, compute_summary"
      pattern: "Dataset|compute_summary"
    - from: "src/small_dataset_audio/ui/state.py"
      to: "small_dataset_audio.config"
      via: "load_config for path resolution"
      pattern: "load_config|resolve_path"
---

<objective>
Install Gradio, create the ui/ package skeleton with AppState singleton, build the 4-tab Blocks layout shell, and implement the complete Data tab with file import, stats display, and waveform thumbnails.

Purpose: Establish the UI foundation that all other tabs build on -- shared state, tab layout, and the first complete tab (Data) that proves the Gradio wiring works end-to-end.

Output: Working Gradio app with Data tab functional; Train/Generate/Library tabs show empty state placeholders.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-gradio-ui/08-RESEARCH.md
@src/small_dataset_audio/ui/__init__.py
@src/small_dataset_audio/data/__init__.py
@src/small_dataset_audio/config/defaults.py
@src/small_dataset_audio/config/settings.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Gradio, create ui/ skeleton, AppState singleton, and guided navigation helpers</name>
  <files>
    pyproject.toml
    src/small_dataset_audio/ui/__init__.py
    src/small_dataset_audio/ui/state.py
    src/small_dataset_audio/ui/components/__init__.py
    src/small_dataset_audio/ui/components/guided_nav.py
    src/small_dataset_audio/ui/tabs/__init__.py
  </files>
  <action>
1. Add `"gradio>=5.0,<7.0"` to the dependencies list in pyproject.toml. Run `uv sync` to install.

2. Create `src/small_dataset_audio/ui/state.py` with an `AppState` dataclass (module-level singleton pattern from RESEARCH.md Pattern 1):
   - Fields: `datasets_dir`, `models_dir`, `generated_dir`, `presets_dir`, `history_dir` (all Path, initialized from config)
   - Fields: `loaded_model` (Optional LoadedModel), `pipeline` (Optional GenerationPipeline), `current_dataset` (Optional Dataset), `current_summary` (Optional DatasetSummary)
   - Fields: `training_runner` (Optional TrainingRunner), `training_active` (bool), `metrics_buffer` (dict for Timer polling)
   - Fields: `preset_manager` (Optional PresetManager), `history_store` (Optional GenerationHistory), `model_library` (Optional ModelLibrary)
   - Fields: `ab_comparison` (Optional ABComparison), `device` (Optional torch.device)
   - Use TYPE_CHECKING guard for all heavy imports (torch, backend classes)
   - Module-level `app_state = AppState()` singleton
   - `init_state(config: dict, device)` function that populates paths from config via `resolve_path`, creates ModelLibrary, sets device
   - `reset_metrics_buffer()` function that clears/initializes the metrics_buffer dict

3. Create `src/small_dataset_audio/ui/components/__init__.py` with empty docstring.

4. Create `src/small_dataset_audio/ui/components/guided_nav.py`:
   - `get_empty_state_message(tab_name: str) -> str` returns Markdown for empty states:
     - "data": "## Import Your Audio Dataset\n\nDrag and drop audio files above or use the folder browse button to import a dataset."
     - "train": "## Import a Dataset to Start Training\n\nGo to the **Data** tab to import audio files first."
     - "generate": "## Load a Model to Start Generating\n\nGo to the **Library** tab to load a trained model, or **Train** a new one first."
     - "library": "## No Models Yet\n\nTrain a model on the **Train** tab, then save it to build your library."
   - `has_dataset() -> bool`, `has_model() -> bool`, `has_training_data() -> bool` convenience checks on app_state

5. Create `src/small_dataset_audio/ui/tabs/__init__.py` with empty docstring.

6. Update `src/small_dataset_audio/ui/__init__.py`:
   - Export `launch_ui` function that calls `create_app().launch()`
   - Export `create_app` from app module
   - Keep it minimal -- app.py created in Task 2
  </action>
  <verify>Run `uv run python -c "import gradio; print(gradio.__version__)"` to confirm Gradio installed. Run `uv run python -c "from small_dataset_audio.ui.state import app_state; print(type(app_state))"` to verify state module.</verify>
  <done>Gradio importable, ui/ skeleton created with AppState singleton, guided navigation helpers, and tabs/__init__.py ready for tab modules.</done>
</task>

<task type="auto">
  <name>Task 2: Build gr.Blocks app shell with 4 tabs and complete Data tab</name>
  <files>
    src/small_dataset_audio/ui/app.py
    src/small_dataset_audio/ui/tabs/data_tab.py
    src/small_dataset_audio/ui/__init__.py
  </files>
  <action>
1. Create `src/small_dataset_audio/ui/app.py`:
   - `create_app() -> gr.Blocks` builds the full Blocks layout:
     - Title: "Small Dataset Audio"
     - `gr.Markdown("# Small Dataset Audio")` header
     - `gr.Tabs()` with 4 `gr.Tab`: "Data" (id="data"), "Train" (id="train"), "Generate" (id="generate"), "Library" (id="library")
     - Data tab calls `build_data_tab()` from data_tab module
     - Train/Generate/Library tabs each display a placeholder `gr.Markdown` with the appropriate empty state message from `guided_nav.get_empty_state_message()`
     - Call `init_state()` using loaded config before building the app (inside `create_app`)
   - `launch_ui()` function:
     - Loads config via `get_config_path()` / `load_config()`
     - Selects device via `select_device()`
     - Calls `init_state(config, device)`
     - Calls `create_app().launch(server_name="127.0.0.1", server_port=7860, share=False, inbrowser=True)`

2. Create `src/small_dataset_audio/ui/tabs/data_tab.py` with `build_data_tab()`:
   - **Import section**: `gr.File` for drag-and-drop (file_count="multiple", file_types=[".wav", ".aiff", ".mp3", ".flac", ".ogg"]), `gr.UploadButton` for directory browse (file_count="directory")
   - **Layout**:
     - `gr.Markdown` with "## Data" header
     - `gr.Row` with `gr.File` (drag-and-drop zone, label="Drop audio files here") and `gr.UploadButton("Browse Folder", file_count="directory")`
     - `gr.Markdown` stats_display (visible=False) for "N files | Xs total | Hz" stats
     - `gr.Gallery` thumbnail_gallery (visible=False, columns=4, height=400) for waveform thumbnails
     - `gr.Audio` for optional clickable playback (visible=False)
   - **Handler `handle_file_upload(files)`**:
     - Accept list of uploaded file objects
     - Copy files to app_state.datasets_dir / "imported" with shutil
     - Create `Dataset.from_directory()` or `Dataset.from_files()` from the copied files
     - Set `app_state.current_dataset` and compute `app_state.current_summary` via `compute_summary()`
     - Generate waveform thumbnails via `generate_dataset_thumbnails()`
     - Return: stats markdown text (count, total duration formatted as HH:MM:SS or seconds, dominant sample rate), list of thumbnail paths for Gallery, visibility updates
   - **Handler `handle_folder_upload(files)`**: Same logic but for directory upload
   - **Handler `handle_thumbnail_click(evt: gr.SelectData)`**: Extract selected thumbnail index, find corresponding audio file in dataset, return file path to `gr.Audio` for playback
   - Wire `.upload` event on gr.File to `handle_file_upload`, `.upload` on UploadButton to `handle_folder_upload`, `.select` on Gallery to `handle_thumbnail_click`

3. Update `src/small_dataset_audio/ui/__init__.py` to export `launch_ui` and `create_app` from `ui.app`.

4. IMPORTANT: Use `matplotlib.use("Agg")` at the top of data_tab.py before any matplotlib imports (headless backend -- project convention).
  </action>
  <verify>Run `uv run python -c "from small_dataset_audio.ui import launch_ui; print('UI ready')"` to verify imports resolve. Then run the app briefly: `timeout 10 uv run python -c "from small_dataset_audio.ui.app import create_app; app = create_app(); print('App created with', len(app.blocks), 'blocks')" 2>&1 || true` to verify the Blocks app builds without errors.</verify>
  <done>Gradio app launches with 4 tabs. Data tab has drag-and-drop upload, folder browse button, stats panel, waveform thumbnail grid, and audio playback on thumbnail click. Train/Generate/Library tabs show guided empty state messages.</done>
</task>

</tasks>

<verification>
1. `uv run python -c "import gradio; print(gradio.__version__)"` succeeds
2. `uv run python -c "from small_dataset_audio.ui import launch_ui"` succeeds (import resolution)
3. `uv run python -c "from small_dataset_audio.ui.state import app_state, init_state; print(type(app_state))"` succeeds
4. `uv run python -c "from small_dataset_audio.ui.tabs.data_tab import build_data_tab; print('OK')"` succeeds
5. `uv run python -c "from small_dataset_audio.ui.components.guided_nav import get_empty_state_message; print(get_empty_state_message('train'))"` shows empty state message
</verification>

<success_criteria>
- Gradio is an installed dependency
- Running `launch_ui()` opens a browser with 4-tab Gradio interface
- Data tab accepts file upload via drag-and-drop and folder browse
- After import, Data tab shows file count, duration, sample rate stats
- After import, Data tab displays waveform thumbnail grid
- Clicking a thumbnail plays the audio file
- Other three tabs show appropriate empty state guidance messages
</success_criteria>

<output>
After completion, create `.planning/phases/08-gradio-ui/08-01-SUMMARY.md`
</output>
