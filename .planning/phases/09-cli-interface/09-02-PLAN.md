---
phase: 09-cli-interface
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/small_dataset_audio/cli/generate.py
  - src/small_dataset_audio/cli/model.py
  - src/small_dataset_audio/cli/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can generate audio from CLI with model name or .sda file path"
    - "User can batch generate N files with incrementing seeds via --count"
    - "User can load a preset by name for generation via --preset"
    - "User can specify --output-dir or default to config's generated path"
    - "User can list all models in the library with `sda model list`"
    - "User can view detailed model info with `sda model info`"
    - "User can delete a model with `sda model delete` (with confirmation)"
    - "Machine-readable JSON output available via --json flag on all commands"
    - "Generated file paths printed to stdout, progress/status to stderr"
  artifacts:
    - path: "src/small_dataset_audio/cli/generate.py"
      provides: "sda generate command with model resolution, batch, preset, export"
      contains: "def generate"
    - path: "src/small_dataset_audio/cli/model.py"
      provides: "sda model list/info/delete commands with Rich tables"
      contains: "def list_models"
  key_links:
    - from: "src/small_dataset_audio/cli/generate.py"
      to: "src/small_dataset_audio/inference/generation.py"
      via: "GenerationPipeline.generate() and .export()"
      pattern: "GenerationPipeline"
    - from: "src/small_dataset_audio/cli/generate.py"
      to: "src/small_dataset_audio/models/persistence.py"
      via: "load_model for model resolution"
      pattern: "load_model"
    - from: "src/small_dataset_audio/cli/generate.py"
      to: "src/small_dataset_audio/presets/manager.py"
      via: "PresetManager.load_preset for --preset flag"
      pattern: "PresetManager"
    - from: "src/small_dataset_audio/cli/model.py"
      to: "src/small_dataset_audio/library/catalog.py"
      via: "ModelLibrary for list/search/get/delete"
      pattern: "ModelLibrary"
---

<objective>
Implement the `sda generate` and `sda model` CLI commands, providing batch audio generation with preset support and model library management from the terminal.

Purpose: These are the two primary read/query commands -- generating audio and browsing/managing models. Together they cover the core headless workflow: find a model, generate audio from it.
Output: Working `sda generate` and `sda model list|info|delete` commands.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cli-interface/09-CONTEXT.md
@.planning/phases/09-cli-interface/09-RESEARCH.md
@.planning/phases/09-cli-interface/09-01-SUMMARY.md
@src/small_dataset_audio/cli/__init__.py
@src/small_dataset_audio/inference/generation.py
@src/small_dataset_audio/models/persistence.py
@src/small_dataset_audio/library/catalog.py
@src/small_dataset_audio/presets/manager.py
@src/small_dataset_audio/controls/mapping.py
@src/small_dataset_audio/config/settings.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement the generate command with model resolution, batch, and preset support</name>
  <files>
    src/small_dataset_audio/cli/generate.py
    src/small_dataset_audio/cli/__init__.py
  </files>
  <action>
Create `src/small_dataset_audio/cli/generate.py`:

1. Create a Typer sub-app: `app = typer.Typer()`.

2. Add a `resolve_model(model_ref, models_dir, device)` helper function:
   - If `model_ref` ends in `.sda` and the path exists, call `load_model(Path(model_ref), device=device)`.
   - Otherwise, instantiate `ModelLibrary(models_dir)`, try `library.get(model_ref)` (UUID lookup).
   - If not found by ID, try `library.search(query=model_ref)` (name search).
   - If exactly 1 result, use it. If >1 results, raise `typer.BadParameter` with ambiguous matches listed. If 0 results, raise `typer.BadParameter("Model not found: ...")`.
   - Load the found model via `load_model(models_dir / entry.file_path, device=device)`.
   - All imports (load_model, ModelLibrary) lazy inside the function.

3. Create `@app.command()` function `generate()` with these Typer-typed parameters:
   - `model: str = typer.Argument(..., help="Model name, ID, or .sda file path")`
   - `duration: float = typer.Option(1.0, "--duration", "-d", help="Duration in seconds (max 60)")`
   - `seed: Annotated[Optional[int], typer.Option("--seed", "-s", help="Random seed (auto-increments for batch)")] = None`
   - `count: int = typer.Option(1, "--count", "-n", help="Number of files to generate")`
   - `preset: Annotated[Optional[str], typer.Option("--preset", "-p", help="Preset name to load (model-scoped)")] = None`
   - `output_dir: Annotated[Optional[Path], typer.Option("--output-dir", "-o", help="Output directory (default: from config)")] = None`
   - `stereo_mode: str = typer.Option("mono", "--stereo", help="Stereo mode: mono, mid_side, dual_seed")`
   - `sample_rate: int = typer.Option(48000, "--sample-rate", help="Output sample rate: 44100, 48000, 96000")`
   - `bit_depth: str = typer.Option("24-bit", "--bit-depth", help="Bit depth: 16-bit, 24-bit, 32-bit-float")`
   - `device: str = typer.Option("auto", "--device", help="Compute device: auto, mps, cuda, cpu")`
   - `config: Annotated[Optional[Path], typer.Option("--config", help="Config file path")] = None`
   - `json_output: bool = typer.Option(False, "--json", help="Output results as JSON to stdout")`

4. Command body (all imports lazy inside function):
   - `console = Console(stderr=True)` for all Rich output (progress/status to stderr).
   - Call `bootstrap(config, device)` to get `(app_config, torch_device, config_path)`.
   - Resolve output_dir: if None, use `resolve_path(app_config["paths"]["generated"], base_dir=config_path.parent)`.
   - Ensure output_dir exists (`output_dir.mkdir(parents=True, exist_ok=True)`).
   - Resolve models_dir from config paths.
   - Call `resolve_model(model, models_dir, str(torch_device))` to get `LoadedModel`.
   - If `preset` is specified:
     - Resolve presets_dir from config paths. The preset path key is "presets" -- check if it exists in app_config["paths"], if not default to `config_path.parent / "data" / "presets"`.
     - Instantiate `PresetManager(presets_dir, loaded.metadata.model_id)` (model_id from loaded model metadata -- check the actual attribute name, it may be `loaded.metadata.model_id` or similar based on the ModelMetadata dataclass).
     - Search for preset by name: `pm.list_presets()` then find matching name (case-insensitive). If not found, raise `typer.BadParameter(f"Preset '{preset}' not found for model '{loaded.metadata.name}'")`.
     - Load preset via `pm.load_preset(preset_id)` to get `PresetEntry`.
     - Convert preset slider positions to latent vector: use `SliderState(positions=preset_entry.slider_positions, n_components=len(preset_entry.slider_positions))` and `sliders_to_latent(slider_state, loaded.analysis)`. Set `gen_config.latent_vector = latent_vector`.
     - If model has no analysis (`loaded.analysis is None`), warn and ignore preset.
   - Build `GenerationConfig(duration_s=duration, seed=seed, stereo_mode=stereo_mode, sample_rate=sample_rate, bit_depth=bit_depth)`. If preset was applied, set latent_vector on it.
   - Create `GenerationPipeline(loaded.model, loaded.spectrogram, torch_device)`.
   - Set `pipeline.model_name = loaded.metadata.name` if available.
   - Loop `count` times:
     - If seed is not None, set `gen_config.seed = seed + i` for each iteration.
     - `result = pipeline.generate(gen_config)`.
     - `wav_path, json_path = pipeline.export(result, output_dir)`.
     - Collect `{"wav": str(wav_path), "json": str(json_path), "seed": result.seed_used}`.
     - Print `console.print(f"[green]Generated:[/green] {wav_path}")` to stderr.
   - After loop: if `json_output`, print `json.dumps(results, indent=2)` to stdout. Otherwise, print each `r["wav"]` to stdout (one path per line) -- these are machine-readable file paths.
   - Exit code 0 on success.

5. Update `cli/__init__.py` to import and register the generate sub-typer:
   `from small_dataset_audio.cli.generate import app as generate_app`
   `app.add_typer(generate_app, name="generate", help="Generate audio from trained models")`
   Remove the try/except guard around this import if it was added in Plan 01.

IMPORTANT: stdout only gets file paths (or JSON). All Rich console output uses `stderr=True`. This enables piping: `sda generate model -n 5 | xargs ls -la`.

IMPORTANT: No dry-run mode (locked decision -- "generation is fast enough that it's unnecessary").

IMPORTANT: Preset loading requires model context (pitfall #5 from research). Model must be resolved before preset lookup.
  </action>
  <verify>
Run `uv run sda generate --help` -- should show all options with help text.
Run `uv run python -c "from small_dataset_audio.cli.generate import app; print('OK')"` -- should succeed.
  </verify>
  <done>
`sda generate MODEL` generates audio and prints file path to stdout. `sda generate MODEL -n 3 -s 42` generates 3 files with seeds 42/43/44. `sda generate MODEL --preset NAME` applies preset slider positions. `--json` outputs structured JSON. `--output-dir` overrides default path. All progress/status goes to stderr.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement model management commands (list, info, delete)</name>
  <files>
    src/small_dataset_audio/cli/model.py
    src/small_dataset_audio/cli/__init__.py
  </files>
  <action>
Create `src/small_dataset_audio/cli/model.py`:

1. Create Typer sub-app: `app = typer.Typer()`.

2. `@app.command("list")` function `list_models()`:
   - Parameters: `device: str = typer.Option("auto", "--device")`, `config: Optional[Path] = typer.Option(None, "--config")`, `json_output: bool = typer.Option(False, "--json")`.
   - `console = Console(stderr=True)`.
   - Call `bootstrap(config, device)` to get config.
   - Resolve models_dir from config paths.
   - Instantiate `ModelLibrary(models_dir)`.
   - Get `entries = library.list_all()`.
   - If `json_output`: `print(json.dumps([asdict(e) for e in entries], indent=2, default=str))` to stdout. Return.
   - Otherwise, build a Rich Table with columns: Name (bold), Dataset, Epochs (right), Val Loss (right), Saved, ID (dim).
   - For each entry, add row with: `entry.name`, `entry.dataset_name`, `str(entry.training_epochs)`, `f"{entry.final_val_loss:.4f}"`, `entry.save_date[:10]`, `entry.model_id[:8]`.
   - If no entries, print "No models found in library." to stderr.
   - `console.print(table)`.

3. `@app.command("info")` function `model_info()`:
   - Parameters: `model: str = typer.Argument(..., help="Model name, ID, or .sda file path")`, `device/config/json_output` options.
   - Bootstrap, resolve models_dir.
   - Find model entry: try `library.get(model)` (ID), then `library.search(query=model)` (name). Handle ambiguous/not found with `typer.BadParameter`.
   - If `json_output`: print `json.dumps(asdict(entry), indent=2, default=str)` to stdout.
   - Otherwise, display detailed info using Rich Panel or formatted output:
     - Name, Description, Model ID (full), File path, File size (human readable), Dataset name, Dataset files, Dataset duration, Training date, Save date, Epochs, Train loss, Val loss, Has analysis, Active PCA components, Tags.
   - Exit code 2 if model not found.

4. `@app.command("delete")` function `delete_model_cmd()`:
   - Parameters: `model: str = typer.Argument(...)`, `force: bool = typer.Option(False, "--force", "-f", help="Skip confirmation")`, device/config options.
   - Bootstrap, resolve models_dir, find model entry (same pattern as info).
   - If not `force`: use `typer.confirm(f"Delete model '{entry.name}' ({entry.model_id[:8]})? This cannot be undone.", abort=True)`.
   - Call `library.delete(entry.model_id)` to remove from index and delete file.
   - Print confirmation message to stderr.
   - Exit code 0 on success, 2 if not found.

5. Update `cli/__init__.py` to register model sub-typer:
   `from small_dataset_audio.cli.model import app as model_app`
   `app.add_typer(model_app, name="model", help="Manage saved models")`

IMPORTANT: All Rich output to stderr via `Console(stderr=True)`. JSON/data output to stdout via `print()`.

IMPORTANT: All heavy imports (ModelLibrary, torch, dataclasses.asdict) lazy inside command functions.

IMPORTANT: Check the actual `ModelLibrary.delete()` method signature -- it may need the model_id and handle file deletion internally, or it may need manual file deletion. Read the catalog.py to confirm.
  </action>
  <verify>
Run `uv run sda model list --help` -- should show list command help.
Run `uv run sda model info --help` -- should show info command help.
Run `uv run sda model delete --help` -- should show delete command with --force flag.
Run `uv run python -c "from small_dataset_audio.cli.model import app; print('OK')"` -- should succeed.
  </verify>
  <done>
`sda model list` shows Rich table of all models. `sda model list --json` outputs JSON array to stdout. `sda model info NAME` shows detailed model info. `sda model delete NAME` prompts for confirmation then deletes. `sda model delete NAME --force` skips confirmation.
  </done>
</task>

</tasks>

<verification>
1. `uv run sda generate --help` shows all options (model, duration, seed, count, preset, output-dir, stereo, sample-rate, bit-depth, device, config, json)
2. `uv run sda model list --help` shows list command
3. `uv run sda model info --help` shows info command
4. `uv run sda model delete --help` shows delete command with --force
5. `uv run sda --help` shows generate and model subcommands
6. All cli modules importable without heavy dependencies loading
</verification>

<success_criteria>
- `sda generate MODEL` generates audio and prints file path(s) to stdout
- `sda generate MODEL -n 5 -s 42` generates 5 files with seeds 42-46
- `sda generate MODEL --preset NAME` applies preset slider positions to generation
- `sda generate MODEL --json` outputs structured JSON results
- `sda model list` displays Rich table of models (or "No models found")
- `sda model info NAME` shows detailed model metadata
- `sda model delete NAME` prompts before deletion
- `sda model delete NAME -f` deletes without prompt
- All --json flags output clean JSON to stdout
- All progress/status messages go to stderr
- Output directory defaults to config's generated path with --output-dir override
</success_criteria>

<output>
After completion, create `.planning/phases/09-cli-interface/09-02-SUMMARY.md`
</output>
