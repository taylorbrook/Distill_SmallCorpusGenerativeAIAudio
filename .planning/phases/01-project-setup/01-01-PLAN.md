---
phase: 01-project-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - Makefile
  - .gitignore
  - .python-version
  - src/small_dataset_audio/__init__.py
  - src/small_dataset_audio/config/__init__.py
  - src/small_dataset_audio/config/defaults.py
  - src/small_dataset_audio/config/settings.py
  - src/small_dataset_audio/hardware/__init__.py
  - src/small_dataset_audio/models/__init__.py
  - src/small_dataset_audio/training/__init__.py
  - src/small_dataset_audio/audio/__init__.py
  - src/small_dataset_audio/inference/__init__.py
  - src/small_dataset_audio/ui/__init__.py
  - src/small_dataset_audio/validation/__init__.py
  - tests/__init__.py
autonomous: true

must_haves:
  truths:
    - "`make setup` installs all dependencies and creates virtual environment in one command"
    - "`uv sync` resolves PyTorch 2.10.0 and TorchAudio 2.10.0 without errors"
    - "Configuration loads defaults when no config.toml exists"
    - "Configuration saves and reloads from TOML file correctly"
    - "Data directories (datasets, models, generated) are user-configurable via config"
  artifacts:
    - path: "pyproject.toml"
      provides: "Package metadata, dependencies, entry points, uv PyTorch index config"
      contains: "small-dataset-audio"
    - path: "Makefile"
      provides: "Common operations (setup, run, test, lint, format, clean, benchmark)"
      contains: "uv sync"
    - path: "src/small_dataset_audio/config/settings.py"
      provides: "TOML config loading, saving, path resolution"
      exports: ["load_config", "save_config", "get_config_path"]
    - path: "src/small_dataset_audio/config/defaults.py"
      provides: "Default configuration values"
      exports: ["DEFAULT_CONFIG"]
  key_links:
    - from: "src/small_dataset_audio/config/settings.py"
      to: "src/small_dataset_audio/config/defaults.py"
      via: "imports DEFAULT_CONFIG for fallback"
      pattern: "from.*defaults.*import.*DEFAULT_CONFIG"
    - from: "pyproject.toml"
      to: "src/small_dataset_audio"
      via: "hatch build targets and entry points"
      pattern: "packages.*small_dataset_audio"
---

<objective>
Scaffold the project structure, packaging, and configuration system.

Purpose: Establish the pip-installable package layout, dependency specifications, build tooling, and TOML-based configuration that all subsequent phases build on. This is the bedrock — every file created in Phases 2-10 lives within this structure.

Output: A working Python package with pyproject.toml, Makefile, src layout with all subpackages, and a configuration system that loads/saves TOML with sensible defaults.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-setup/01-RESEARCH.md
@.planning/phases/01-project-setup/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project scaffolding and packaging</name>
  <files>
    pyproject.toml
    Makefile
    .gitignore
    .python-version
    src/small_dataset_audio/__init__.py
    src/small_dataset_audio/config/__init__.py
    src/small_dataset_audio/hardware/__init__.py
    src/small_dataset_audio/models/__init__.py
    src/small_dataset_audio/training/__init__.py
    src/small_dataset_audio/audio/__init__.py
    src/small_dataset_audio/inference/__init__.py
    src/small_dataset_audio/ui/__init__.py
    src/small_dataset_audio/validation/__init__.py
    tests/__init__.py
    data/datasets/.gitkeep
    data/models/.gitkeep
    data/generated/.gitkeep
  </files>
  <action>
    Create the complete project scaffolding per the research-recommended structure.

    **pyproject.toml** — Use the EXACT template from 01-RESEARCH.md Code Examples section. Key details:
    - `name = "small-dataset-audio"`, `version = "0.1.0"`
    - `requires-python = ">=3.11,<3.15"`
    - Dependencies: `torch>=2.10.0,<2.11`, `torchaudio>=2.10.0,<2.11`, `tomli-w>=1.1.0`, `rich>=14.0`, `psutil>=6.0`
    - Entry point: `sda = "small_dataset_audio.app:main"`
    - Build system: hatchling with `packages = ["src/small_dataset_audio"]`
    - uv sources: pytorch-cu128 index for Linux only (macOS MPS works from PyPI default)
    - Dev dependencies: pytest>=8.0, pytest-cov>=6.0, ruff>=0.9

    **Makefile** — Use the EXACT template from 01-RESEARCH.md. Targets: help, setup, run, run-verbose, test, lint, format, clean, benchmark. `PYTHON := uv run python`, `MODULE := small_dataset_audio`.

    **.gitignore** — Standard Python gitignore plus:
    - `config.toml` (user-specific config, created on first run)
    - `data/datasets/*`, `data/models/*`, `data/generated/*` (user data, keep .gitkeep files)
    - `.venv/`, `__pycache__/`, `*.egg-info/`, `dist/`, `build/`
    - `.pytest_cache/`, `.ruff_cache/`
    - `uv.lock` should NOT be gitignored (lockfile is committed for reproducibility)

    **.python-version** — Set to `3.11` (minimum supported version, uv uses this for venv creation).

    **src/small_dataset_audio/__init__.py** — Package init with `__version__ = "0.1.0"` and a docstring.

    **Subpackage __init__.py files** — Each gets a brief docstring describing its domain:
    - `config/`: "Configuration loading, saving, and defaults."
    - `hardware/`: "Hardware detection, device abstraction, and benchmarking."
    - `models/`: "Neural network model definitions." (placeholder for Phase 3)
    - `training/`: "Training loop and optimization." (placeholder for Phase 3)
    - `audio/`: "Audio I/O, preprocessing, and augmentation." (placeholder for Phase 2)
    - `inference/`: "Audio generation from trained models." (placeholder for Phase 4)
    - `ui/`: "User interfaces (Gradio, CLI)." (placeholder for Phase 8)
    - `validation/`: "Environment validation and startup checks."

    **tests/__init__.py** — Empty init.

    **data/ directories** — Create `data/datasets/`, `data/models/`, `data/generated/` with `.gitkeep` files so empty directories are tracked by git.
  </action>
  <verify>
    1. `ls pyproject.toml Makefile .gitignore .python-version` — all exist
    2. `ls src/small_dataset_audio/__init__.py` — package root exists
    3. `ls src/small_dataset_audio/config/__init__.py src/small_dataset_audio/hardware/__init__.py src/small_dataset_audio/validation/__init__.py` — core subpackages exist
    4. `ls data/datasets/.gitkeep data/models/.gitkeep data/generated/.gitkeep` — data dirs exist
    5. `grep "small-dataset-audio" pyproject.toml` — package name correct
    6. `grep "sda" pyproject.toml` — entry point defined
    7. `grep "uv sync" Makefile` — setup target uses uv
  </verify>
  <done>
    All project files exist. pyproject.toml declares correct dependencies (torch, torchaudio, tomli-w, rich, psutil), entry point (sda), and build system (hatchling). Makefile has setup/run/test/lint/format/clean/benchmark targets. Directory structure matches research-recommended layout with all subpackages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement configuration system with TOML support</name>
  <files>
    src/small_dataset_audio/config/defaults.py
    src/small_dataset_audio/config/settings.py
  </files>
  <action>
    Create the configuration system using tomllib (read) and tomli-w (write).

    **src/small_dataset_audio/config/defaults.py:**

    Define `DEFAULT_CONFIG` as a nested dict with these sections:

    ```python
    DEFAULT_CONFIG = {
        "general": {
            "project_name": "Small Dataset Audio",
            "first_run_complete": False,
        },
        "paths": {
            "datasets": "data/datasets",
            "models": "data/models",
            "generated": "data/generated",
        },
        "hardware": {
            "device": "auto",          # "auto", "mps", "cuda", "cpu"
            "max_batch_size": 0,       # 0 = not yet benchmarked, set by benchmark
            "memory_limit_gb": 0.0,    # 0.0 = not yet measured
        },
    }
    ```

    Note: Use `0` and `0.0` instead of `None` for TOML compatibility (TOML has no null type). The code should treat `0` / `0.0` as "not set" for these fields.

    **src/small_dataset_audio/config/settings.py:**

    Implement these functions:

    1. `get_config_path() -> Path` — Returns the path to config.toml. Uses the project root (determined by finding the nearest directory containing pyproject.toml, walking up from the package location). Falls back to current working directory.

    2. `load_config(config_path: Path | None = None) -> dict` — Load config from TOML file. If file doesn't exist, return a deep copy of DEFAULT_CONFIG. If file exists, read with tomllib. Merge with defaults so new config keys added in future versions are present (use a recursive dict merge — existing values override defaults, but missing sections/keys get defaults).

    3. `save_config(config: dict, config_path: Path | None = None) -> None` — Save config dict to TOML file using tomli-w. Create parent directories if needed.

    4. `resolve_path(path_str: str, base_dir: Path | None = None) -> Path` — Resolve a config path string to an absolute Path. If path is relative, resolve against base_dir (defaults to project root). If path is absolute, return as-is. Expand ~ (user home).

    Import DEFAULT_CONFIG from defaults.py. Do NOT import torch or any heavy dependencies in this module — config must work even when PyTorch is broken (so we can report config-level errors before checking PyTorch).

    Add type hints to all function signatures. Add docstrings to all public functions.
  </action>
  <verify>
    1. `uv run python -c "from small_dataset_audio.config.defaults import DEFAULT_CONFIG; print(DEFAULT_CONFIG)"` — imports and prints defaults
    2. `uv run python -c "from small_dataset_audio.config.settings import load_config; c = load_config(); print(c['general']['project_name'])"` — loads defaults when no config.toml exists
    3. `uv run python -c "
from small_dataset_audio.config.settings import load_config, save_config, get_config_path
from pathlib import Path
import tempfile, tomllib
with tempfile.NamedTemporaryFile(suffix='.toml', delete=False) as f:
    p = Path(f.name)
c = load_config()
c['hardware']['device'] = 'cpu'
save_config(c, p)
c2 = load_config(p)
assert c2['hardware']['device'] == 'cpu', 'Save/load roundtrip failed'
print('Save/load roundtrip: OK')
p.unlink()
"` — config saves and reloads correctly
  </verify>
  <done>
    Configuration system loads defaults when no file exists, saves to TOML, reloads correctly, and merges with defaults for forward compatibility. Config module has no PyTorch dependency. All paths are user-configurable.
  </done>
</task>

</tasks>

<verification>
1. Project structure matches research-recommended layout (src/ with nested packages)
2. `make setup` target exists and runs `uv sync`
3. pyproject.toml has correct dependencies and entry point
4. Config loads defaults, saves TOML, and reloads without error
5. Config module does not import torch (verify with grep)
6. All subpackage __init__.py files exist
</verification>

<success_criteria>
- pyproject.toml defines small-dataset-audio with all Phase 1 dependencies
- Makefile provides setup, run, test, lint, format, clean, benchmark targets
- Configuration system loads/saves TOML with default fallback
- All src/small_dataset_audio/ subpackages have __init__.py
- data/ directories exist with .gitkeep markers
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup/01-01-SUMMARY.md`
</output>
