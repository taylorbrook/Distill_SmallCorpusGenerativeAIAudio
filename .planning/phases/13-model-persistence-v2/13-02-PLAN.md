---
phase: 13-model-persistence-v2
plan: 02
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - src/distill/library/catalog.py
  - src/distill/models/persistence.py  # Second modification (after Plan 01): adds VocoderInfo catalog entry creation to save_model()
  - src/distill/cli/generate.py
  - src/distill/cli/model.py
  - src/distill/ui/components/model_card.py
  - src/distill/ui/tabs/library_tab.py
  - src/distill/training/loop.py
  - src/distill/training/runner.py
autonomous: true
requirements:
  - PERS-01
  - PERS-03

must_haves:
  truths:
    - "Model catalog shows vocoder training stats (epochs, loss) when a model has a trained vocoder"
    - "CLI 'model list' table works with new format and shows vocoder column"
    - "CLI 'model info' displays vocoder training details or '(none)' when no vocoder"
    - "CLI 'generate' rejects v1 .distill file paths with clear error and accepts .distillgan paths"
    - "Model cards in the UI show a HiFi-GAN badge with epoch/loss stats when vocoder is present"
    - "Library tab table includes a Vocoder column"
    - "Catalog repair_index scans for *.distillgan files (not *.distill)"
    - "No remaining references to .distill extension in code or docstrings (except v1 rejection messages and audio metadata tag)"
  artifacts:
    - path: "src/distill/library/catalog.py"
      provides: "VocoderInfo dataclass, extended ModelEntry, updated repair_index, bumped _INDEX_VERSION"
      contains: "VocoderInfo"
    - path: "src/distill/cli/generate.py"
      provides: "v1 .distill rejection, .distillgan path support"
      contains: "distillgan"
    - path: "src/distill/cli/model.py"
      provides: "Vocoder stats in model info and list displays"
      contains: "vocoder"
    - path: "src/distill/ui/components/model_card.py"
      provides: "HiFi-GAN badge rendering in model cards"
      contains: "HiFi-GAN"
    - path: "src/distill/ui/tabs/library_tab.py"
      provides: "Vocoder column in table view"
      contains: "Vocoder"
  key_links:
    - from: "src/distill/library/catalog.py"
      to: "VocoderInfo dataclass"
      via: "ModelEntry.vocoder field"
      pattern: "vocoder.*VocoderInfo"
    - from: "src/distill/library/catalog.py"
      to: "_load_index deserialization"
      via: "VocoderInfo reconstruction from dict"
      pattern: "VocoderInfo\\(\\*\\*"
    - from: "src/distill/models/persistence.py"
      to: "src/distill/library/catalog.py"
      via: "ModelEntry creation in save_model with vocoder field"
      pattern: "ModelEntry\\("
---

<objective>
Sweep all catalog, CLI, UI, and training references from the old .distill format to .distillgan, add VocoderInfo to the catalog, and update all display layers to show vocoder training stats.

Purpose: Completes the format migration across every touchpoint in the application. After this plan, no code path references the old format (except v1 rejection messages), and the catalog/UI/CLI all support the new vocoder metadata.

Output: Updated catalog with VocoderInfo, CLI with v1 rejection and vocoder display, UI cards and table with vocoder stats, and clean sweep of all .distill references.
</objective>

<execution_context>
@C:/Users/Taylor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Taylor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/13-model-persistence-v2/13-CONTEXT.md
@.planning/phases/13-model-persistence-v2/13-RESEARCH.md
@.planning/phases/13-model-persistence-v2/13-01-SUMMARY.md
@src/distill/library/catalog.py
@src/distill/cli/generate.py
@src/distill/cli/model.py
@src/distill/ui/components/model_card.py
@src/distill/ui/tabs/library_tab.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend catalog with VocoderInfo, update ModelEntry, repair_index, and index version</name>
  <files>src/distill/library/catalog.py</files>
  <action>
**Add VocoderInfo dataclass** (before ModelEntry):
```python
@dataclass
class VocoderInfo:
    """Vocoder training metadata for catalog display."""
    type: str              # "hifigan_v2" (future-proofed for other vocoder types)
    epochs: int
    final_loss: float
    training_date: str     # ISO 8601
```

**Extend ModelEntry** with optional vocoder field at the end (must be after all existing fields, with default None so existing entries deserialize without error):
```python
vocoder: VocoderInfo | None = None
```

**Bump _INDEX_VERSION** from 1 to 2.

**Update _load_index()** deserialization to reconstruct VocoderInfo from nested dict:
In the `for model_id, entry_dict in models_raw.items():` loop, before constructing `ModelEntry(**entry_dict)`, pop and reconstruct the vocoder:
```python
vocoder_raw = entry_dict.pop("vocoder", None)
vocoder = VocoderInfo(**vocoder_raw) if vocoder_raw else None
entries[model_id] = ModelEntry(**entry_dict, vocoder=vocoder)
```
This avoids the Pitfall 5 (VocoderInfo deserialization) where `ModelEntry(**dict)` would receive a raw dict instead of a VocoderInfo instance.

**Update repair_index():**
- Change the glob from `"*.distill"` to `"*.distillgan"` (line 366)
- Update all comments from `.distill` to `.distillgan`
- In the orphan file scanning, the `ModelEntry(...)` construction should include `vocoder=None` (orphan files from disk won't have vocoder info extracted here -- that's loaded from metadata, not from the torch file directly. Keep it simple: orphans get `vocoder=None`).

**Update module docstring** at the top: change all references from `.distill` to `.distillgan`.

**Update ModelLibrary class docstring** and `__init__` docstring: change `.distill` to `.distillgan`.

**Update save_model in persistence.py** (from Plan 01) entry creation: After Plan 01 runs, persistence.py's `save_model` creates a `ModelEntry` -- it needs to pass `vocoder=None` since the vocoder catalog info comes from a different path. However, since `vocoder` has a default of `None`, no change to persistence.py is needed. The `ModelEntry(**kwargs)` call in `save_model` doesn't need to explicitly pass `vocoder=None` because it defaults.

But the `save_model` function DOES need to be updated to pass vocoder info to the catalog entry when vocoder_state is provided. Add this logic:

In `src/distill/models/persistence.py`'s `save_model()`, after building the catalog `entry = ModelEntry(...)`, add:
```python
# If vocoder state is bundled, create VocoderInfo for catalog
if vocoder_state is not None:
    from distill.library.catalog import VocoderInfo
    training_meta = vocoder_state.get("training_metadata", {})
    entry.vocoder = VocoderInfo(
        type=vocoder_state.get("type", "hifigan_v2"),
        epochs=training_meta.get("epochs", 0),
        final_loss=training_meta.get("final_loss", 0.0),
        training_date=training_meta.get("training_date", ""),
    )
```

Wait -- this touches persistence.py which is in Plan 01's file list. Let me reconsider. The VocoderInfo class is defined in catalog.py (this plan). And persistence.py's save_model needs to import it. Since Plan 01 already modifies persistence.py, and Plan 02 depends on Plan 01, I should handle the VocoderInfo import in persistence.py here.

**Actually**: Add the VocoderInfo catalog entry creation in `persistence.py`'s `save_model` function. This is a small 6-line addition to persistence.py. Since Plan 01 has already been executed and Plan 02 depends on it, this is safe -- we're adding to an already-modified file.

In `src/distill/models/persistence.py` `save_model()`, after the line `library.add_entry(entry)`, add before it:
```python
# Populate vocoder info for catalog if vocoder state is bundled
if vocoder_state is not None:
    from distill.library.catalog import VocoderInfo
    training_meta = vocoder_state.get("training_metadata", {})
    entry.vocoder = VocoderInfo(
        type=vocoder_state.get("type", "hifigan_v2"),
        epochs=training_meta.get("epochs", 0),
        final_loss=training_meta.get("final_loss", 0.0),
        training_date=training_meta.get("training_date", ""),
    )
```
Place this between the `entry = ModelEntry(...)` block and `library.add_entry(entry)`.
  </action>
  <verify>
Run: `python -c "from distill.library.catalog import VocoderInfo, ModelEntry; vi = VocoderInfo(type='hifigan_v2', epochs=100, final_loss=0.03, training_date='2026-01-01'); me = ModelEntry(model_id='x', name='t', description='', file_path='t.distillgan', file_size_bytes=100, dataset_name='', dataset_file_count=0, dataset_total_duration_s=0, training_date='', save_date='', training_epochs=10, final_train_loss=0.1, final_val_loss=0.2, has_analysis=False, n_active_components=0, vocoder=vi); assert me.vocoder.epochs == 100; print('OK')"` -- should print OK.
  </verify>
  <done>
VocoderInfo dataclass defined. ModelEntry extended with optional vocoder field. _INDEX_VERSION bumped to 2. _load_index handles VocoderInfo deserialization from nested dict. repair_index scans *.distillgan. All docstrings reference .distillgan. persistence.py save_model populates VocoderInfo from vocoder_state when present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI, UI, and training references for .distillgan format and vocoder display</name>
  <files>
    src/distill/cli/generate.py
    src/distill/cli/model.py
    src/distill/ui/components/model_card.py
    src/distill/ui/tabs/library_tab.py
    src/distill/training/loop.py
    src/distill/training/runner.py
  </files>
  <action>
**cli/generate.py -- resolve_model():**
- Add v1 rejection at the top of the function:
  ```python
  if model_ref.endswith(".distill"):
      raise typer.BadParameter(
          "This model was saved in v1 format (.distill) which is no longer "
          "supported. Please retrain your model."
      )
  ```
- Change `if model_ref.endswith(".distill"):` to `if model_ref.endswith(".distillgan"):` for the direct file path loading
- Update all docstrings/comments from `.distill` to `.distillgan`
- Update the `model` argument help text in the `generate()` function from `.distill file path` to `.distillgan file path`

**cli/model.py -- model_info():**
- Add vocoder stats display in the Rich detail table. After the "Tags" row, add:
  ```python
  if hasattr(entry, 'vocoder') and entry.vocoder is not None:
      table.add_row("Vocoder", f"HiFi-GAN ({entry.vocoder.epochs} epochs, loss {entry.vocoder.final_loss:.4f})")
      table.add_row("Vocoder Trained", entry.vocoder.training_date[:10] if entry.vocoder.training_date else "(unknown)")
  else:
      table.add_row("Vocoder", "(none)")
  ```
- Update `model` argument help text from `.distill file path` to `.distillgan file path`

**cli/model.py -- list_models():**
- Add a "Vocoder" column to the Rich table
- For each entry, show vocoder status: `f"HiFi-GAN ({entry.vocoder.epochs}ep)"` if `entry.vocoder is not None` else `""`

**ui/components/model_card.py -- render_single_card():**
- After the components/size paragraph (before `{tags_str}`), add vocoder badge display:
  ```python
  vocoder_str = ""
  if hasattr(model, 'vocoder') and model.vocoder is not None:
      vocoder_str = (
          f'<p style="margin: 4px 0; font-size: 0.9em;">'
          f'<span style="background: #d1fae5; color: #065f46; '
          f'padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">'
          f'HiFi-GAN</span> '
          f'{model.vocoder.epochs} epochs &middot; '
          f'loss {model.vocoder.final_loss:.4f}'
          f'</p>'
      )
  ```
  Insert `{vocoder_str}` in the card HTML template between the components line and `{tags_str}`.

**ui/tabs/library_tab.py:**
- Add "Vocoder" to `_TABLE_HEADERS` list: `["Name", "Dataset", "Files", "Epochs", "Date", "Components", "Vocoder"]`
- Update `_models_to_table()` to include vocoder column:
  ```python
  vocoder_str = ""
  if hasattr(m, 'vocoder') and m.vocoder is not None:
      vocoder_str = f"HiFi-GAN ({m.vocoder.epochs}ep)"
  rows.append([..., vocoder_str])
  ```
- Update the `table_view` Dataframe `datatype` to include `"str"` for the vocoder column

**training/loop.py:**
- Line 707: Change comment from `# Save as .distill model to the library` to `# Save as .distillgan model to the library`

**training/runner.py:**
- Line 100: Change docstring from `.distill model file` to `.distillgan model file`
- Line 170: Change docstring from `.distill model file` to `.distillgan model file`

**IMPORTANT: Do NOT change `src/distill/audio/metadata.py`**. The `distill_model` reference there (line 138) is an audio metadata tag key for provenance embedding in exported audio -- it's unrelated to the model file format and must stay as-is.
  </action>
  <verify>
1. Run: `python -c "from distill.library.catalog import ModelEntry, VocoderInfo; print('catalog OK')"` -- imports work
2. Run: `python -c "from distill.cli.generate import resolve_model; print('generate OK')"` -- imports work
3. Run: `python -c "from distill.cli.model import list_models; print('model OK')"` -- imports work
4. Grep for remaining `.distill` references (excluding v1 rejection messages and audio/metadata.py): should find none
  </verify>
  <done>
CLI generate rejects v1 .distill paths with clear error and supports .distillgan paths. CLI model list/info display vocoder stats. Model cards show HiFi-GAN badge. Library tab table has Vocoder column. All training docstrings updated. No remaining .distill references except v1 rejection messages and audio metadata tag.
  </done>
</task>

</tasks>

<verification>
1. Comprehensive grep: `grep -rn "\.distill" src/distill/ --include="*.py" | grep -v "distillgan" | grep -v "audio/metadata.py" | grep -v "v1 format"` -- should only show v1 rejection string literals (the error messages that mention ".distill" by design)
2. `python -c "from distill.library.catalog import VocoderInfo, ModelEntry, _INDEX_VERSION; assert _INDEX_VERSION == 2; print('index version OK')"`
3. `python -c "from distill.models.persistence import MODEL_FORMAT_MARKER, MODEL_FILE_EXTENSION; assert MODEL_FORMAT_MARKER == 'distillgan_model'; assert MODEL_FILE_EXTENSION == '.distillgan'; print('constants OK')"`
4. All files import successfully without errors
</verification>

<success_criteria>
- VocoderInfo dataclass exists in catalog.py with type, epochs, final_loss, training_date fields
- ModelEntry has optional vocoder: VocoderInfo | None field
- _INDEX_VERSION is 2
- _load_index correctly deserializes VocoderInfo from nested dict
- repair_index globs for *.distillgan
- CLI generate rejects .distill paths, accepts .distillgan paths
- CLI model info shows vocoder stats or "(none)"
- CLI model list has Vocoder column
- Model cards display HiFi-GAN badge when vocoder present
- Library tab table has Vocoder column
- All .distill references swept to .distillgan (except v1 rejection messages and audio metadata tag)
- persistence.py save_model creates VocoderInfo catalog entry from vocoder_state when provided
</success_criteria>

<output>
After completion, create `.planning/phases/13-model-persistence-v2/13-02-SUMMARY.md`
</output>
