---
phase: 13-model-persistence-v2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/distill/models/persistence.py
  - src/distill/models/__init__.py
autonomous: true
requirements:
  - PERS-01
  - PERS-02

must_haves:
  truths:
    - "Saving a model produces a .distillgan file with format marker 'distillgan_model' and version 1"
    - "Loading a .distillgan file returns a LoadedModel with vocoder_state field (None when no vocoder bundled)"
    - "Attempting to load a v1 .distill file raises ValueError with clear 'retrain your model' message"
    - "save_model accepts an optional vocoder_state parameter that is stored in the model file when provided"
    - "save_model_from_checkpoint produces .distillgan files (not .distill)"
    - "delete_model removes .distillgan files correctly"
  artifacts:
    - path: "src/distill/models/persistence.py"
      provides: "Updated constants, save/load with vocoder support, v1 rejection"
      contains: "distillgan_model"
    - path: "src/distill/models/__init__.py"
      provides: "Re-exports of updated constants and MODEL_FORMAT_MARKER"
      exports: ["MODEL_FILE_EXTENSION", "MODEL_FORMAT_MARKER", "SAVED_MODEL_VERSION", "LoadedModel", "save_model", "load_model"]
  key_links:
    - from: "src/distill/models/persistence.py"
      to: "torch.save dict"
      via: "vocoder_state key in saved dict"
      pattern: "vocoder_state"
    - from: "src/distill/models/persistence.py"
      to: "LoadedModel dataclass"
      via: "vocoder_state field passthrough"
      pattern: "vocoder_state.*saved\\.get"
---

<objective>
Update the core model persistence layer to the new .distillgan format with optional vocoder state bundling and v1 rejection.

Purpose: Establishes the new model file format that all downstream code (catalog, CLI, UI) will consume. This is the foundation for Phase 16's per-model HiFi-GAN training, which needs vocoder state to be saved/loaded from model files.

Output: Updated persistence.py with new constants, vocoder-aware save/load, v1 rejection, and updated __init__.py re-exports.
</objective>

<execution_context>
@C:/Users/Taylor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Taylor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/13-model-persistence-v2/13-CONTEXT.md
@.planning/phases/13-model-persistence-v2/13-RESEARCH.md
@src/distill/models/persistence.py
@src/distill/models/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update constants, dataclasses, and save/load pipeline for .distillgan format with vocoder support</name>
  <files>src/distill/models/persistence.py</files>
  <action>
Update the three constants at the top of persistence.py:
- `SAVED_MODEL_VERSION = 1` (stays 1 -- this is a NEW format, not v2 of the old one)
- `MODEL_FORMAT_MARKER = "distillgan_model"` (was `"distill_model"`)
- `MODEL_FILE_EXTENSION = ".distillgan"` (was `".distill"`)

Add `MODEL_FORMAT_MARKER` to the constants section if not already there (it's used but not exported yet).

Extend `LoadedModel` dataclass with:
```python
vocoder_state: dict | None = None
```
This field holds the raw vocoder state dict (state_dict + config + training_metadata) or None. Phase 16 will use this to reconstruct the HiFi-GAN model.

Update `save_model()`:
- Add parameter `vocoder_state: dict | None = None` after the `analysis` parameter
- After building the `saved` dict, conditionally add vocoder state: `if vocoder_state is not None: saved["vocoder_state"] = vocoder_state` (omit key entirely when absent, per discretion recommendation)
- Update the ModelEntry creation to pass `vocoder=None` (no VocoderInfo here -- that's a catalog concern, handled in Plan 02)
- Update all docstring references from `.distill` to `.distillgan`

Update `load_model()`:
- Add v1 format rejection BEFORE the existing format check:
  ```python
  fmt = saved.get("format", "")
  if fmt == "distill_model":
      raise ValueError(
          "This model was saved in v1 format which is no longer supported. "
          "Please retrain your model."
      )
  if fmt != MODEL_FORMAT_MARKER:
      raise ValueError(f"Not a valid .distillgan model file: {model_path}")
  ```
- After model reconstruction, extract vocoder state: `vocoder_state = saved.get("vocoder_state")`
- Pass `vocoder_state=vocoder_state` to the returned `LoadedModel`
- Update all docstring references from `.distill` to `.distillgan`

Update `delete_model()`:
- Update docstring references from `.distill` to `.distillgan`
- The comment "Delete the .distill file" should become "Delete the .distillgan file"

Update `save_model_from_checkpoint()`:
- Update docstring references from `.distill` to `.distillgan`

Update the module docstring at the top of the file:
- Change references from ``.distill`` to ``.distillgan`` throughout
  </action>
  <verify>
Run: `python -c "from distill.models.persistence import MODEL_FORMAT_MARKER, MODEL_FILE_EXTENSION, SAVED_MODEL_VERSION, LoadedModel; assert MODEL_FORMAT_MARKER == 'distillgan_model'; assert MODEL_FILE_EXTENSION == '.distillgan'; assert SAVED_MODEL_VERSION == 1; assert hasattr(LoadedModel, 'vocoder_state'); print('OK')"` -- should print OK.
  </verify>
  <done>
Constants updated to distillgan_model / .distillgan / version 1. LoadedModel has vocoder_state field. save_model accepts vocoder_state parameter. load_model rejects v1 format with clear error and extracts vocoder_state from new format. All docstrings reference .distillgan.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update __init__.py re-exports to include MODEL_FORMAT_MARKER</name>
  <files>src/distill/models/__init__.py</files>
  <action>
Update `src/distill/models/__init__.py`:
- Add `MODEL_FORMAT_MARKER` to the import from `distill.models.persistence`
- Add `"MODEL_FORMAT_MARKER"` to the `__all__` list

The existing imports of `MODEL_FILE_EXTENSION` and `SAVED_MODEL_VERSION` will automatically pick up the new values since they import the names, not the values. No changes needed for those.

The file should import and re-export: MODEL_FILE_EXTENSION, MODEL_FORMAT_MARKER, SAVED_MODEL_VERSION, LoadedModel, ModelMetadata, save_model, load_model, delete_model, save_model_from_checkpoint.
  </action>
  <verify>
Run: `python -c "from distill.models import MODEL_FORMAT_MARKER, MODEL_FILE_EXTENSION; assert MODEL_FORMAT_MARKER == 'distillgan_model'; assert MODEL_FILE_EXTENSION == '.distillgan'; print('OK')"` -- should print OK.
  </verify>
  <done>
__init__.py re-exports MODEL_FORMAT_MARKER alongside the existing exports. All constant names available from `distill.models` package.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from distill.models.persistence import MODEL_FORMAT_MARKER, MODEL_FILE_EXTENSION, SAVED_MODEL_VERSION; print(MODEL_FORMAT_MARKER, MODEL_FILE_EXTENSION, SAVED_MODEL_VERSION)"` prints `distillgan_model .distillgan 1`
2. `python -c "from distill.models.persistence import LoadedModel; lm = LoadedModel.__dataclass_fields__; assert 'vocoder_state' in lm; print('vocoder_state field exists')"` confirms vocoder_state field
3. `python -c "from distill.models import MODEL_FORMAT_MARKER; print(MODEL_FORMAT_MARKER)"` prints `distillgan_model`
4. Grep confirms no remaining `distill_model` (as format marker) or `\.distill"` in persistence.py (excluding the v1 rejection string literal)
</verification>

<success_criteria>
- MODEL_FORMAT_MARKER is "distillgan_model"
- MODEL_FILE_EXTENSION is ".distillgan"
- SAVED_MODEL_VERSION is 1
- LoadedModel has vocoder_state: dict | None field
- save_model accepts vocoder_state parameter
- load_model rejects v1 "distill_model" format with clear error message
- load_model extracts vocoder_state from saved dict
- All docstrings in persistence.py reference .distillgan
- __init__.py re-exports MODEL_FORMAT_MARKER
</success_criteria>

<output>
After completion, create `.planning/phases/13-model-persistence-v2/13-01-SUMMARY.md`
</output>
