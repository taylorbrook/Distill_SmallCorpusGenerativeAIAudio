---
phase: 12-vocoder-interface-bigvgan-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vendor/bigvgan/
  - vendor/bigvgan/VENDOR_PIN.txt
  - pyproject.toml
  - src/distill/vocoder/__init__.py
  - src/distill/vocoder/base.py
autonomous: true
requirements:
  - VOC-06

must_haves:
  truths:
    - "BigVGAN source code exists in vendor/bigvgan/ as a complete, unmodified copy"
    - "Version is pinned via VENDOR_PIN.txt with commit hash"
    - "huggingface_hub and librosa are listed as project dependencies"
    - "Abstract VocoderBase class defines the mel_to_waveform contract"
  artifacts:
    - path: "vendor/bigvgan/bigvgan.py"
      provides: "BigVGAN model source code"
    - path: "vendor/bigvgan/meldataset.py"
      provides: "BigVGAN mel spectrogram computation"
    - path: "vendor/bigvgan/activations.py"
      provides: "Snake/SnakeBeta activation functions"
    - path: "vendor/bigvgan/LICENSE"
      provides: "MIT license preservation"
    - path: "vendor/bigvgan/VENDOR_PIN.txt"
      provides: "Version pinning commit hash"
    - path: "src/distill/vocoder/__init__.py"
      provides: "Vocoder package public API"
    - path: "src/distill/vocoder/base.py"
      provides: "Abstract VocoderBase class"
    - path: "pyproject.toml"
      provides: "Updated dependencies"
  key_links:
    - from: "src/distill/vocoder/__init__.py"
      to: "src/distill/vocoder/base.py"
      via: "re-export VocoderBase"
      pattern: "from .base import VocoderBase"
---

<objective>
Vendor BigVGAN source code, add required dependencies, and create the abstract vocoder interface.

Purpose: Establish the foundation that all subsequent vocoder plans build on -- vendored BigVGAN source, new Python dependencies, and the abstract contract that BigVGAN and future HiFi-GAN V2 implementations will satisfy.

Output: `vendor/bigvgan/` directory with complete NVIDIA BigVGAN source, updated `pyproject.toml` with huggingface_hub and librosa, and `src/distill/vocoder/` package with abstract base class.
</objective>

<execution_context>
@C:/Users/Taylor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Taylor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-vocoder-interface-bigvgan-integration/12-RESEARCH.md
@pyproject.toml
@src/distill/audio/spectrogram.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vendor BigVGAN source code into vendor/bigvgan/</name>
  <files>
    vendor/bigvgan/
    vendor/bigvgan/VENDOR_PIN.txt
  </files>
  <action>
Clone the NVIDIA/BigVGAN repository and copy the FULL contents into `vendor/bigvgan/` at the project root. This is a complete, unmodified copy -- do not strip any files (model variants, training code, configs all included per user decision).

Steps:
1. Clone `https://github.com/NVIDIA/BigVGAN.git` to a temporary location
2. Copy all files into `vendor/bigvgan/` (preserve directory structure)
3. Create `vendor/bigvgan/VENDOR_PIN.txt` containing the commit hash used (e.g., `68eac6eeda4c4fde3e666a4f61387a54c79a742e` or the current HEAD at time of cloning)
4. Ensure `vendor/bigvgan/LICENSE` exists (MIT license, per user decision to preserve as-is)
5. Remove the `.git` directory from the vendored copy (we don't want a nested git repo)

IMPORTANT: Do NOT modify any vendored files. All adaptations will be done in `src/distill/vocoder/` wrappers.

The vendor directory should contain at minimum: `bigvgan.py`, `meldataset.py`, `activations.py`, `alias_free_activation/`, `env.py`, `utils.py`, `configs/`, `LICENSE`.
  </action>
  <verify>
Verify the vendored directory structure:
- `ls vendor/bigvgan/bigvgan.py` exists
- `ls vendor/bigvgan/meldataset.py` exists
- `ls vendor/bigvgan/activations.py` exists
- `ls vendor/bigvgan/LICENSE` exists
- `cat vendor/bigvgan/VENDOR_PIN.txt` shows a commit hash
- No `.git` directory in `vendor/bigvgan/`
  </verify>
  <done>
vendor/bigvgan/ contains the complete, unmodified NVIDIA BigVGAN source with LICENSE preserved and VENDOR_PIN.txt recording the exact commit hash.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dependencies and create vocoder interface package</name>
  <files>
    pyproject.toml
    src/distill/vocoder/__init__.py
    src/distill/vocoder/base.py
  </files>
  <action>
**Part A: Add dependencies**

Add `huggingface_hub` and `librosa` to `pyproject.toml` dependencies:
- `"huggingface_hub>=0.20"` -- BigVGAN's `from_pretrained` depends on this; handles weight download, caching, offline mode, progress bars
- `"librosa>=0.10"` -- required for Slaney-normalized mel filterbank computation matching BigVGAN's training data

Run `uv sync` to install the new dependencies and verify no conflicts with existing packages.

Note on librosa: If `librosa` causes dependency issues (pulls in numba, llvmlite), document the issue but proceed. The research notes this as a discretion item -- if problematic, the Slaney filterbank can be extracted as ~30 lines of numpy in a later fix. Try adding it first.

**Part B: Create vocoder package**

Create `src/distill/vocoder/` package with two files:

1. `src/distill/vocoder/base.py` -- Abstract vocoder interface:

```python
from abc import ABC, abstractmethod
import torch

class VocoderBase(ABC):
    """Abstract vocoder interface for mel-to-waveform conversion.

    All vocoders accept VAE-format mel spectrograms (log1p, HTK, 48kHz)
    and handle internal conversion to their expected format.
    """

    @abstractmethod
    def mel_to_waveform(self, mel: torch.Tensor) -> torch.Tensor:
        """Convert mel spectrogram to waveform.

        Parameters
        ----------
        mel : torch.Tensor
            VAE output mel spectrogram in log1p format.
            Shape: [B, 1, n_mels, time]

        Returns
        -------
        torch.Tensor
            Waveform at vocoder's native sample rate.
            Shape: [B, 1, samples]
        """
        ...

    @property
    @abstractmethod
    def sample_rate(self) -> int:
        """Native output sample rate of this vocoder."""
        ...

    @abstractmethod
    def to(self, device: torch.device) -> "VocoderBase":
        """Move vocoder to device. Returns self for chaining."""
        ...
```

Use lazy torch import pattern consistent with project conventions (see `src/distill/hardware/device.py` for the pattern: `from __future__ import annotations`, TYPE_CHECKING guard for type hints, import torch inside method bodies or `__init__`).

2. `src/distill/vocoder/__init__.py` -- Public API:

Re-export `VocoderBase` from the package. Include a `get_vocoder()` factory function stub that will be completed in Plan 02:

```python
from distill.vocoder.base import VocoderBase

__all__ = ["VocoderBase", "get_vocoder"]

def get_vocoder(vocoder_type: str = "bigvgan", device: str = "auto") -> VocoderBase:
    """Get a vocoder instance by type.

    Parameters
    ----------
    vocoder_type : str
        One of "bigvgan" (universal) or "hifigan" (per-model, Phase 16).
    device : str
        Device preference: "auto", "cuda", "mps", or "cpu".

    Returns
    -------
    VocoderBase
        Ready-to-use vocoder instance on the selected device.
    """
    raise NotImplementedError(
        f"Vocoder type '{vocoder_type}' not yet implemented. "
        "BigVGAN implementation coming in plan 02."
    )
```
  </action>
  <verify>
- `uv sync` completes without errors
- `python -c "from distill.vocoder import VocoderBase; print(VocoderBase)"` prints the class
- `python -c "import huggingface_hub; print(huggingface_hub.__version__)"` shows version >= 0.20
- `python -c "import librosa; print(librosa.__version__)"` shows version >= 0.10
  </verify>
  <done>
pyproject.toml includes huggingface_hub and librosa. The src/distill/vocoder/ package exists with VocoderBase abstract class defining the mel_to_waveform, sample_rate, and to(device) contract. get_vocoder() factory function is stubbed for Plan 02 implementation.
  </done>
</task>

</tasks>

<verification>
1. `vendor/bigvgan/bigvgan.py` exists and is the unmodified NVIDIA source
2. `vendor/bigvgan/VENDOR_PIN.txt` contains a valid commit hash
3. `vendor/bigvgan/LICENSE` exists (MIT)
4. `pyproject.toml` lists huggingface_hub and librosa
5. `uv sync` succeeds
6. `from distill.vocoder import VocoderBase` imports successfully
7. `VocoderBase` has abstract methods: mel_to_waveform, sample_rate, to
</verification>

<success_criteria>
BigVGAN source is vendored with version pinning, new dependencies install cleanly, and the abstract vocoder interface is importable and defines the contract for mel-to-waveform conversion.
</success_criteria>

<output>
After completion, create `.planning/phases/12-vocoder-interface-bigvgan-integration/12-01-SUMMARY.md`
</output>
