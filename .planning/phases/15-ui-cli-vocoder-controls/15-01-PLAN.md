---
phase: 15-ui-cli-vocoder-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/distill/vocoder/__init__.py
  - src/distill/vocoder/weight_manager.py
  - src/distill/vocoder/bigvgan_vocoder.py
  - src/distill/ui/tabs/generate_tab.py
  - src/distill/ui/tabs/library_tab.py
autonomous: true
requirements: [UI-01, UI-02]
must_haves:
  truths:
    - "Generate tab shows a collapsible Vocoder Settings accordion with dropdown (Auto / BigVGAN Universal) and status text"
    - "Per-model HiFi-GAN only appears as a dropdown choice when the loaded model has vocoder_state"
    - "BigVGAN download progress is visible in the UI during first download (not a frozen interface)"
    - "Generate button is disabled with 'Downloading vocoder...' label during BigVGAN download and re-enabled after"
    - "Vocoder is resolved at generate time (not model load time), enabling lazy download"
    - "Quality badge after generation shows which vocoder was used"
  artifacts:
    - path: "src/distill/vocoder/__init__.py"
      provides: "resolve_vocoder() function with auto-selection logic"
      exports: ["resolve_vocoder"]
    - path: "src/distill/vocoder/weight_manager.py"
      provides: "tqdm_class parameter for customizable download progress"
      contains: "tqdm_class"
    - path: "src/distill/ui/tabs/generate_tab.py"
      provides: "Vocoder Settings accordion with dropdown, status, progress, retry button"
      contains: "Vocoder Settings"
    - path: "src/distill/ui/tabs/library_tab.py"
      provides: "Deferred vocoder creation (no vocoder at model load time)"
  key_links:
    - from: "src/distill/ui/tabs/generate_tab.py"
      to: "src/distill/vocoder/__init__.py"
      via: "resolve_vocoder() call in _generate_audio handler"
      pattern: "resolve_vocoder"
    - from: "src/distill/vocoder/__init__.py"
      to: "src/distill/vocoder/weight_manager.py"
      via: "tqdm_class parameter forwarded to ensure_bigvgan_weights"
      pattern: "tqdm_class"
    - from: "src/distill/ui/tabs/library_tab.py"
      to: "src/distill/inference/generation.py"
      via: "GenerationPipeline created without vocoder at model load"
      pattern: "GenerationPipeline"
---

<objective>
Add vocoder auto-resolution logic, customizable download progress, and a Vocoder Settings accordion to the Gradio UI Generate tab. Users see vocoder selection, download progress during first use, and vocoder info in the quality badge.

Purpose: Implements UI-01 (vocoder selection control) and UI-02 (download progress visibility) -- the two UI requirements for Phase 15.
Output: `resolve_vocoder()` shared function, tqdm_class-aware weight manager, Vocoder Settings accordion in Generate tab.
</objective>

<execution_context>
@C:/Users/Taylor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Taylor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-ui-cli-vocoder-controls/15-CONTEXT.md
@.planning/phases/15-ui-cli-vocoder-controls/15-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/distill/vocoder/__init__.py:
```python
def get_vocoder(vocoder_type: str = "bigvgan", device: str = "auto") -> VocoderBase:
    """Get a vocoder instance by type. Types: 'bigvgan', 'hifigan'."""
```

From src/distill/vocoder/weight_manager.py:
```python
def ensure_bigvgan_weights() -> Path:
    """Ensure BigVGAN weights are available locally, downloading if needed."""

def is_bigvgan_cached() -> bool:
    """Check if BigVGAN weights are already cached."""
```

From src/distill/vocoder/base.py:
```python
class VocoderBase(ABC):
    def mel_to_waveform(self, mel: torch.Tensor) -> torch.Tensor: ...
    @property
    def sample_rate(self) -> int: ...
    def to(self, device: torch.device) -> VocoderBase: ...
```

From src/distill/models/persistence.py:
```python
@dataclass
class LoadedModel:
    model: Module
    spectrogram: SpectrogramConfig
    analysis: AnalysisResult | None
    metadata: ModelMetadata
    device: torch.device
    vocoder_state: dict | None = None
```

From src/distill/ui/state.py:
```python
class AppState:
    loaded_model: Optional[LoadedModel] = None
    pipeline: Optional[GenerationPipeline] = None
    device: Optional[torch.device] = None
```

From src/distill/ui/tabs/generate_tab.py:
```python
def _quality_badge_markdown(quality: dict) -> str:
    """Build a Markdown badge from a quality score dict."""

def _generate_audio(*args):
    """Generate audio from slider values and generation config."""

def build_generate_tab() -> dict:
    """Build the Generate tab UI. Returns component reference dict."""
```

From src/distill/ui/tabs/library_tab.py (load handler, line 163-172):
```python
from distill.vocoder import get_vocoder
vocoder = get_vocoder("bigvgan", device=device_str)
app_state.pipeline = GenerationPipeline(
    model=loaded.model,
    spectrogram=loaded.spectrogram,
    device=loaded.device,
    vocoder=vocoder,
)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add resolve_vocoder() and tqdm_class support to vocoder package</name>
  <files>src/distill/vocoder/__init__.py, src/distill/vocoder/weight_manager.py, src/distill/vocoder/bigvgan_vocoder.py</files>
  <action>
**In `src/distill/vocoder/__init__.py`:**

1. Add `resolve_vocoder` to `__all__` list.

2. Add the `resolve_vocoder()` function after `get_vocoder()`:

```python
def resolve_vocoder(
    selection: str,  # "auto", "bigvgan", "hifigan"
    loaded_model: "LoadedModel",
    device: str = "auto",
    tqdm_class: type | None = None,
) -> tuple["VocoderBase", dict]:
    """Resolve vocoder selection to a concrete vocoder instance.

    Returns (vocoder, info_dict) where info_dict contains:
      - name: "bigvgan_universal" or "per_model_hifigan"
      - selection: "auto" or "bigvgan" or "hifigan"
      - reason: human-readable explanation of auto-selection
    """
    has_per_model = loaded_model.vocoder_state is not None

    if selection == "hifigan":
        if not has_per_model:
            raise ValueError(
                f"Model '{loaded_model.metadata.name}' has no trained "
                "per-model vocoder. Use --vocoder auto or bigvgan."
            )
        # Phase 16: load per-model HiFi-GAN from vocoder_state
        raise NotImplementedError("Per-model HiFi-GAN vocoder is Phase 16.")

    if selection == "auto":
        if has_per_model:
            # Phase 16: prefer per-model when available
            # For now, always fall through to BigVGAN
            pass
        return (
            get_vocoder("bigvgan", device=device, tqdm_class=tqdm_class),
            {"name": "bigvgan_universal", "selection": "auto",
             "reason": "no per-model vocoder"},
        )

    if selection == "bigvgan":
        return (
            get_vocoder("bigvgan", device=device, tqdm_class=tqdm_class),
            {"name": "bigvgan_universal", "selection": "bigvgan",
             "reason": "explicit"},
        )

    raise ValueError(
        f"Unknown vocoder selection: {selection!r}. Use 'auto', 'bigvgan', or 'hifigan'."
    )
```

3. Update `get_vocoder()` to accept and forward `tqdm_class`:
   - Add `tqdm_class: type | None = None` parameter
   - Pass it to `BigVGANVocoder(device=device, tqdm_class=tqdm_class)`

**In `src/distill/vocoder/weight_manager.py`:**

4. Add `tqdm_class` parameter to `ensure_bigvgan_weights()`:
   - Signature: `def ensure_bigvgan_weights(tqdm_class: type | None = None) -> Path:`
   - When `tqdm_class is not None`, pass `tqdm_class=tqdm_class` as kwarg to `snapshot_download()`.
   - The `local_files_only=True` fallback call does NOT need `tqdm_class` (no download happening).

**In `src/distill/vocoder/bigvgan_vocoder.py`:**

5. Update `BigVGANVocoder.__init__()` to accept `tqdm_class: type | None = None` and forward it to `ensure_bigvgan_weights(tqdm_class=tqdm_class)`.

**NOTE:** The `TYPE_CHECKING` import for `LoadedModel` in `__init__.py` is needed:
```python
if TYPE_CHECKING:
    from distill.models.persistence import LoadedModel
```
  </action>
  <verify>
    <automated>cd H:/dev/Distill-hifigan && python -c "from distill.vocoder import resolve_vocoder, get_vocoder; print('resolve_vocoder imported OK'); print(resolve_vocoder.__doc__[:50])"</automated>
  </verify>
  <done>
    - `resolve_vocoder()` exists in `distill.vocoder` and is importable
    - `get_vocoder()` accepts `tqdm_class` parameter
    - `ensure_bigvgan_weights()` accepts `tqdm_class` parameter
    - `BigVGANVocoder.__init__()` accepts and forwards `tqdm_class`
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Vocoder Settings accordion to Generate tab and defer vocoder creation</name>
  <files>src/distill/ui/tabs/generate_tab.py, src/distill/ui/tabs/library_tab.py</files>
  <action>
**In `src/distill/ui/tabs/generate_tab.py`:**

1. **Update `_quality_badge_markdown()`** to accept optional `vocoder_info: dict | None = None` parameter. When provided, append vocoder name to badge:
   ```python
   if vocoder_info:
       vocoder_label = "BigVGAN Universal" if vocoder_info["name"] == "bigvgan_universal" else "Per-model HiFi-GAN"
       badge += f" | **Vocoder:** {vocoder_label}"
   ```

2. **Update `_generate_audio()` handler** to:
   - Accept `gr.Progress(track_tqdm=True)` parameter for download progress: add `progress=gr.Progress(track_tqdm=True)` as final kwarg.
   - **Convert `_generate_audio()` to a generator** (use `yield`) so it can disable the generate button before download and re-enable it after. At the START of the handler, check if BigVGAN is not cached (`from distill.vocoder.weight_manager import is_bigvgan_cached`). If not cached, yield an intermediate update that disables the generate button with a "Downloading vocoder..." label:
     ```python
     from distill.vocoder.weight_manager import is_bigvgan_cached
     if not is_bigvgan_cached():
         yield {
             generate_btn: gr.update(interactive=False, value="Downloading vocoder..."),
         }
     ```
     After vocoder resolution completes (download finished), yield the final results dict that re-enables the generate button:
     ```python
     yield {
         generate_btn: gr.update(interactive=True, value="Generate"),
         # ... other outputs ...
     }
     ```
     This implements the locked decision: "Generate button disabled during download with tooltip 'Downloading vocoder...'".
   - Before generation, resolve vocoder using `resolve_vocoder()`:
     ```python
     from distill.vocoder import resolve_vocoder
     vocoder_selection = args[MAX_SLIDERS + 6]  # new arg from dropdown
     ```
   - Determine vocoder selection string from dropdown value: map "Auto" -> "auto", "BigVGAN Universal" -> "bigvgan", "Per-model HiFi-GAN" -> "hifigan".
   - Call `resolve_vocoder(selection, app_state.loaded_model, device=device_str)`.
   - If vocoder resolution raises `ValueError` (e.g., hifigan requested but no per-model vocoder), return error message in the vocoder_status output.
   - If vocoder resolution raises `OSError` (download failure), return error in vocoder_progress output and make retry button visible; re-enable generate button in the error return.
   - Update `app_state.pipeline.vocoder` with the resolved vocoder (or recreate pipeline with new vocoder).
   - After generation, pass `vocoder_info` to `_quality_badge_markdown()`.
   - Return updated vocoder_status text (e.g., "**Using:** BigVGAN Universal") as one of the outputs.
   - **Important:** Update the return tuple and all early-return error paths to include the new outputs (generate_btn, vocoder_status, vocoder_progress, retry_btn visibility). The generate_btn MUST be restored to `gr.update(interactive=True, value="Generate")` in every return path.

3. **Add Vocoder Settings accordion** in `build_generate_tab()`, placed **after** the "### Generation Config" section and its rows, **before** the "### Seed row" section:
   ```python
   with gr.Accordion("Vocoder Settings", open=False) as vocoder_accordion:
       vocoder_dropdown = gr.Dropdown(
           choices=["Auto", "BigVGAN Universal"],
           value="Auto",
           label="Vocoder",
           info="Auto selects the best available vocoder for your model",
       )
       vocoder_status = gr.Markdown(
           value="**Using:** BigVGAN Universal",
       )
       vocoder_progress = gr.Markdown(value="", visible=False)
       retry_download_btn = gr.Button(
           "Retry Download", visible=False, variant="secondary", size="sm",
       )
   ```

4. **Update generate_btn.click** to include `vocoder_dropdown` in inputs and add `generate_btn` itself plus new outputs (vocoder_status, vocoder_progress, retry_download_btn) to the outputs list. The `generate_btn` must be in outputs so the generator can disable/re-enable it during download. Example:
   ```python
   generate_btn.click(
       fn=_generate_audio,
       inputs=[..., vocoder_dropdown],
       outputs=[..., generate_btn, vocoder_status, vocoder_progress, retry_download_btn],
   )
   ```

5. **Add `_update_vocoder_choices()` handler** that updates dropdown choices when model changes. Called from `_update_sliders_for_model()`:
   - If `app_state.loaded_model` has `vocoder_state is not None`, set choices to `["Auto", "BigVGAN Universal", "Per-model HiFi-GAN"]`.
   - Otherwise set choices to `["Auto", "BigVGAN Universal"]` with info text "(model has no per-model vocoder)".
   - Return `gr.update(choices=..., value="Auto")` for the dropdown + updated status text.

6. **Wire vocoder_dropdown and retry_download_btn** into build_generate_tab return dict and event handlers.

7. **Wire retry_download_btn.click** to trigger `_generate_audio` again (or a simpler retry handler that just calls `ensure_bigvgan_weights()`).

8. **Return updated component dict** from `build_generate_tab()` adding `"vocoder_dropdown"`, `"vocoder_status"`.

**In `src/distill/ui/tabs/library_tab.py`:**

9. **Defer vocoder creation from model load time.** In `_load_model_handler()`:
   - Remove the `from distill.vocoder import get_vocoder` and `vocoder = get_vocoder("bigvgan", device=device_str)` lines.
   - Pass `vocoder=None` to `GenerationPipeline()` constructor. If `GenerationPipeline` requires a vocoder, defer pipeline creation entirely -- set `app_state.pipeline = None` and create it at generate time in `_generate_audio()`. Check GenerationPipeline's constructor: if it requires vocoder, create pipeline in generate handler instead. Research (Pitfall 4) says: "pass `vocoder=None` during model load and create vocoder in the generate handler."
   - The key insight: vocoder download should happen on first Generate click, not on model Load click.

**IMPORTANT per CONTEXT.md locked decisions:**
- Accordion collapsed by default (open=False). Use Claude's discretion on smart-open: auto-open when model has per-model vocoder available.
- Download is LAZY -- triggered on first generate attempt, not app startup or model load.
- Generate button disabled during download with tooltip "Downloading vocoder...".
- On download failure: error message in accordion + Retry Download button (NOT Gradio toast).
- Status text shows readiness + resolution: "Using: BigVGAN Universal".
  </action>
  <verify>
    <automated>cd H:/dev/Distill-hifigan && python -c "from distill.ui.tabs.generate_tab import build_generate_tab; print('generate_tab imports OK')"</automated>
  </verify>
  <done>
    - Vocoder Settings accordion visible in Generate tab with dropdown and status text
    - Dropdown shows "Auto" and "BigVGAN Universal" (and "Per-model HiFi-GAN" when model has vocoder_state)
    - _generate_audio() resolves vocoder at generate time via resolve_vocoder()
    - Download triggers on first generate, not on model load
    - Generate button disabled with "Downloading vocoder..." label during BigVGAN download, re-enabled after
    - Quality badge includes vocoder name after generation
    - Error handling for download failure shows inline error + retry button, re-enables generate button
    - library_tab.py no longer creates vocoder at model load time
  </done>
</task>

</tasks>

<verification>
1. `python -c "from distill.vocoder import resolve_vocoder; print('OK')"` -- resolve_vocoder is importable
2. `python -c "from distill.ui.tabs.generate_tab import build_generate_tab; print('OK')"` -- generate tab builds without error
3. Manual check: Vocoder Settings accordion exists in Generate tab with dropdown (Auto / BigVGAN Universal)
4. Manual check: Loading a model does NOT trigger BigVGAN download
5. Manual check: Clicking Generate triggers vocoder download if not cached
</verification>

<success_criteria>
- resolve_vocoder() function in distill.vocoder returns (VocoderBase, info_dict)
- Generate tab has Vocoder Settings accordion with dropdown and status
- Vocoder download is lazy (first generate, not model load)
- Quality badge shows vocoder used
- Download progress visible via Gradio's Progress(track_tqdm=True)
</success_criteria>

<output>
After completion, create `.planning/phases/15-ui-cli-vocoder-controls/15-01-SUMMARY.md`
</output>
