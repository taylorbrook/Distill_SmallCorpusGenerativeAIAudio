---
phase: 15-generation-pipeline
plan: 02
type: execute
wave: 2
depends_on:
  - "15-01"
files_modified:
  - src/distill/ui/tabs/generate_tab.py
  - src/distill/ui/state.py
autonomous: true
requirements:
  - UI-04

must_haves:
  truths:
    - "Generate tab shows temperature, top-k, top-p, duration, crossfade overlap, and seed controls when a VQ-VAE model with prior is loaded"
    - "Clicking Generate produces audible audio output in the audio player"
    - "Progress bar shows chunk counter during multi-chunk generation"
    - "v1.0 slider/preset/blend controls are hidden for VQ-VAE models"
  artifacts:
    - path: "src/distill/ui/tabs/generate_tab.py"
      provides: "Prior-based generate tab with sampling controls"
      contains: "def _generate_prior_audio"
    - path: "src/distill/ui/state.py"
      provides: "loaded_vq_model field on AppState for VQ-VAE model state"
      contains: "loaded_vq_model"
  key_links:
    - from: "src/distill/ui/tabs/generate_tab.py"
      to: "src/distill/inference/generation.py"
      via: "generate_audio_from_prior() call in handler"
      pattern: "generate_audio_from_prior"
    - from: "src/distill/ui/tabs/generate_tab.py"
      to: "src/distill/ui/state.py"
      via: "app_state.loaded_vq_model for VQ-VAE model access"
      pattern: "app_state\\.loaded_vq_model"
---

<objective>
Replace the v1.0 slider-based generate tab with prior-based sampling controls for VQ-VAE models, including temperature, top-k, top-p sliders, duration slider, crossfade overlap control, seed input, and progress-bar generation.

Purpose: Users need a UI to generate audio from trained priors. The v1.0 generate tab controls (PCA sliders, presets, blend) are irrelevant for VQ-VAE models -- this replaces them with the appropriate prior sampling controls.

Output: Reworked generate_tab.py with prior-based controls, updated state.py with loaded_vq_model field.
</objective>

<execution_context>
@C:/Users/Taylor/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Taylor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-generation-pipeline/15-RESEARCH.md
@.planning/phases/15-generation-pipeline/15-01-SUMMARY.md
@src/distill/ui/tabs/generate_tab.py
@src/distill/ui/state.py
@src/distill/inference/generation.py
@src/distill/models/persistence.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loaded_vq_model to AppState and create prior generation handler</name>
  <files>
    src/distill/ui/state.py
    src/distill/ui/tabs/generate_tab.py
  </files>
  <action>
**state.py changes:**

Add a `loaded_vq_model` field to the `AppState` dataclass:
```python
loaded_vq_model: Optional[LoadedVQModel] = None
```
Add `LoadedVQModel` to the TYPE_CHECKING imports from `distill.models.persistence`.

**generate_tab.py changes:**

Add a new handler function `_generate_prior_audio()` that will be wired to the generate button when a VQ-VAE model is loaded. Place it alongside the existing `_generate_audio()` handler.

```python
def _generate_prior_audio(
    temperature, top_k, top_p, duration, overlap_ms, seed_val,
    progress=gr.Progress()
):
```

Implementation:
1. Validate: if `app_state.loaded_vq_model is None` or `app_state.loaded_vq_model.prior is None`, return `(None, "**No VQ-VAE model with prior loaded.** Train a prior first.")` with appropriate gr.update() for hidden audio.
2. Parse seed: `seed = int(seed_val) if seed_val is not None and seed_val != "" else None`
3. Compute overlap_samples from overlap_ms: `overlap_samples = int(float(overlap_ms) * 48)` (48 samples per ms at 48kHz)
4. Call `generate_audio_from_prior()` with a progress callback that wraps `gr.Progress`:
   ```python
   def _progress_cb(fraction, desc):
       progress(fraction, desc=desc)
   ```
5. Import lazily inside the function body: `from distill.inference.generation import generate_audio_from_prior`
6. Call: `audio, seed_used = generate_audio_from_prior(loaded=app_state.loaded_vq_model, temperature=float(temperature), top_k=int(top_k), top_p=float(top_p), duration_s=float(duration), overlap_samples=overlap_samples, seed=seed, progress_callback=_progress_cb)`
7. Store result info in `app_state.metrics_buffer["last_prior_result"]` for potential export.
8. Return `((48000, audio), f"**Generated** -- seed: {seed_used}, duration: {len(audio)/48000:.1f}s", gr.update(visible=True))`

Handle exceptions with try/except, returning error message on failure.

The existing `_generate_audio()` handler stays untouched for v1.0 models.
  </action>
  <verify>
Run: `cd H:/dev/Distill-vqvae && python -c "from distill.ui.state import AppState; a = AppState(); print('loaded_vq_model' in a.__dataclass_fields__)"`
Run: `cd H:/dev/Distill-vqvae && python -c "from distill.ui.tabs.generate_tab import _generate_prior_audio; print('handler import OK')"`
  </verify>
  <done>
AppState has loaded_vq_model field. _generate_prior_audio handler exists, calls generate_audio_from_prior() with progress updates, returns (sample_rate, audio) tuple for gr.Audio.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build prior-based generate tab UI section with sampling controls</name>
  <files>src/distill/ui/tabs/generate_tab.py</files>
  <action>
Modify `build_generate_tab()` in `src/distill/ui/tabs/generate_tab.py` to add a prior-based controls section alongside the existing v1.0 section.

**Strategy:** Do NOT delete the v1.0 controls. Instead, add a new `prior_controls_section` Column (initially hidden) that shows when a VQ-VAE model is loaded. The existing `controls_section` (v1.0 sliders) hides when a VQ-VAE model is loaded.

**Add the prior controls section AFTER the empty_msg and BEFORE the v1.0 controls_section:**

```python
# Prior-based controls section -- visible when VQ-VAE model with prior loaded
with gr.Column(visible=False) as prior_controls_section:
    gr.Markdown("## Generate from Prior")
```

Inside `prior_controls_section`, create these controls per user decisions:

1. **Sampling controls row:**
   - Temperature slider: `gr.Slider(minimum=0.1, maximum=2.0, value=1.0, step=0.05, label="Temperature", info="Higher = more diverse, lower = more focused")`
   - Top-p slider: `gr.Slider(minimum=0.0, maximum=1.0, value=0.9, step=0.05, label="Top-p (Nucleus)", info="0 = disabled. Lower = more focused.")`
   - Top-k slider: `gr.Slider(minimum=0, maximum=512, value=0, step=1, label="Top-k", info="0 = disabled. Lower = fewer choices per step.")`

2. **Duration and overlap row:**
   - Duration slider: `gr.Slider(minimum=1, maximum=30, value=10, step=1, label="Duration (seconds)")`
   - Crossfade overlap slider: `gr.Slider(minimum=0, maximum=200, value=50, step=10, label="Crossfade Overlap (ms)", info="Overlap between chunks. 50ms default.")`

3. **Seed row:**
   - Seed input: `gr.Number(label="Seed", value=None, precision=0)`
   - Randomize button: `gr.Button("Randomize", size="sm")`

4. **Generate button:**
   - `gr.Button("Generate", variant="primary", size="lg")`

5. **Audio output section:**
   - `gr.Audio(label="Generated Audio", visible=False, type="numpy", interactive=False, autoplay=False)`
   - Status markdown: `gr.Markdown(value="")`

6. **Export section:** Reuse the same export pattern as v1.0 (format dropdown, sample rate, bit depth, filename, export button). Can be a simplified version: format dropdown, export button, status.

**Wire event handlers:**

- Randomize button -> seed input (reuse `_randomize_seed`)
- Generate button -> `_generate_prior_audio` with inputs `[temperature, top_p, top_k, duration, overlap, seed]` and outputs `[audio_output, status_md, audio_output_visibility]`

**Add a helper function `_update_generate_tab_for_model()` that returns visibility updates:**
- When `app_state.loaded_vq_model is not None and app_state.loaded_vq_model.prior is not None`: show `prior_controls_section`, hide `controls_section` (v1.0), hide `empty_msg`
- When `app_state.loaded_model is not None` (v1.0 model): show `controls_section`, hide `prior_controls_section`, hide `empty_msg`
- When neither loaded: show `empty_msg`, hide both control sections

Return `prior_controls_section` in the component reference dict so cross-tab wiring (model loading in library tab) can trigger visibility updates.
  </action>
  <verify>
Run: `cd H:/dev/Distill-vqvae && python -c "from distill.ui.tabs.generate_tab import build_generate_tab; print('tab builder import OK')"`
Grep for "prior_controls_section" in generate_tab.py to confirm the section exists.
Grep for "Temperature" in generate_tab.py to confirm the slider exists.
  </verify>
  <done>
Generate tab has a prior_controls_section with temperature (0.1-2.0, default 1.0), top-p (0-1.0, default 0.9), top-k (0-512, default 0), duration (1-30s, default 10), crossfade overlap (0-200ms, default 50), seed input, generate button, audio output, and status display. v1.0 controls hide when VQ-VAE model loaded. Prior controls hide when v1.0 model loaded.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from distill.ui.tabs.generate_tab import build_generate_tab"` -- import succeeds
2. `python -c "from distill.ui.state import app_state; print(hasattr(app_state, 'loaded_vq_model'))"` -- returns True
3. Grep for `_generate_prior_audio` in generate_tab.py -- handler exists
4. Grep for `prior_controls_section` in generate_tab.py -- UI section exists
5. Grep for `generate_audio_from_prior` in generate_tab.py -- backend is called
</verification>

<success_criteria>
- Prior controls section visible with all sampling sliders at correct ranges/defaults per user decisions
- Generate button calls generate_audio_from_prior() and plays result in audio player
- Progress bar shows chunk counter during multi-chunk generation
- v1.0 controls hidden when VQ-VAE model loaded, prior controls hidden when v1.0 model loaded
- loaded_vq_model field exists on AppState for cross-tab wiring
</success_criteria>

<output>
After completion, create `.planning/phases/15-generation-pipeline/15-02-SUMMARY.md`
</output>
