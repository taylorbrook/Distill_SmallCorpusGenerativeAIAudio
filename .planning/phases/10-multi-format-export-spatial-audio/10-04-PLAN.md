---
phase: 10-multi-format-export-spatial-audio
plan: 04
type: execute
wave: 2
depends_on: ["10-01", "10-02", "10-03"]
files_modified:
  - src/small_dataset_audio/inference/generation.py
  - src/small_dataset_audio/ui/tabs/generate_tab.py
  - src/small_dataset_audio/ui/state.py
  - src/small_dataset_audio/ui/app.py
autonomous: true

must_haves:
  truths:
    - "User can select export format (WAV, MP3, FLAC, OGG) in the Generate tab"
    - "User can configure spatial audio with width and depth sliders and output mode selector in the Generate tab"
    - "User can load multiple models and configure blend weights in the Generate tab"
    - "User can toggle between latent-space and audio-domain blending in the UI"
    - "GenerationPipeline uses new SpatialConfig instead of old stereo_mode/stereo_width"
    - "Export button supports all 4 formats with metadata embedding"
    - "Metadata fields (artist, album, title) are editable before export"
  artifacts:
    - path: "src/small_dataset_audio/inference/generation.py"
      provides: "Updated GenerationConfig with SpatialConfig and ExportFormat; updated pipeline using apply_spatial"
      contains: "SpatialConfig"
    - path: "src/small_dataset_audio/ui/tabs/generate_tab.py"
      provides: "Format selector, spatial controls, multi-model blend panel"
      contains: "SpatialMode"
    - path: "src/small_dataset_audio/ui/state.py"
      provides: "BlendEngine reference in AppState"
      contains: "blend_engine"
  key_links:
    - from: "src/small_dataset_audio/inference/generation.py"
      to: "src/small_dataset_audio/inference/spatial.py"
      via: "GenerationPipeline.generate calls apply_spatial instead of old stereo functions"
      pattern: "apply_spatial"
    - from: "src/small_dataset_audio/ui/tabs/generate_tab.py"
      to: "src/small_dataset_audio/inference/blending.py"
      via: "Generate tab uses BlendEngine for multi-model generation"
      pattern: "blend_engine"
---

<objective>
Integrate multi-format export, spatial audio, and multi-model blending into the GenerationPipeline and Gradio UI.

Purpose: Wire the three new backend systems (export formats, spatial audio, model blending) into the generation pipeline and provide full UI controls. This is the user-facing integration that makes Phase 10 features accessible.

Output: Updated GenerationConfig/GenerationPipeline with spatial and format support; Generate tab with format selector, spatial controls (mode/width/depth), and multi-model blend panel; AppState with BlendEngine.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-multi-format-export-spatial-audio/10-CONTEXT.md
@.planning/phases/10-multi-format-export-spatial-audio/10-RESEARCH.md
@.planning/phases/10-multi-format-export-spatial-audio/10-01-SUMMARY.md
@.planning/phases/10-multi-format-export-spatial-audio/10-02-SUMMARY.md
@.planning/phases/10-multi-format-export-spatial-audio/10-03-SUMMARY.md
@src/small_dataset_audio/inference/generation.py
@src/small_dataset_audio/ui/tabs/generate_tab.py
@src/small_dataset_audio/ui/state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update GenerationConfig and GenerationPipeline with SpatialConfig and ExportFormat</name>
  <files>
    src/small_dataset_audio/inference/generation.py
  </files>
  <action>
1. Update `GenerationConfig` in `generation.py`:
   - Add `spatial: SpatialConfig | None = None` field. When set, replaces old stereo_mode/stereo_width behavior.
   - Add `export_format: str = "wav"` field. String matches ExportFormat values ("wav", "mp3", "flac", "ogg").
   - Keep `stereo_mode` and `stereo_width` fields for backward compatibility but mark with comments as deprecated.
   - Update `validate()`:
     - If `spatial` is not None, call `spatial.validate()`.
     - If `spatial` is None but `stereo_mode` is set, create a SpatialConfig via `migrate_stereo_config` for backward compat (do this transparently).
     - Validate export_format is one of "wav", "mp3", "flac", "ogg".

2. Update `GenerationPipeline.generate()`:
   - Replace the stereo processing block (steps 6/7 in current pipeline):
     - If `config.spatial` is not None, use it. Otherwise, build SpatialConfig from old stereo_mode/stereo_width via migrate_stereo_config.
     - For MONO mode: skip spatial processing, channels = 1.
     - For STEREO mode:
       - If dual_seed concat mode: generate right channel with seed+1, then call `apply_spatial_to_dual_seed(audio, audio_right, spatial_config, internal_sr)`.
       - Otherwise: call `apply_spatial(audio, spatial_config, internal_sr)`.
       - channels = 2.
     - For BINAURAL mode: similar to STEREO but apply_spatial handles binaural internally.
       - If dual_seed: generate both channels, average to mono, apply binaural.
       - Otherwise: apply binaural to mono.
       - channels = 2.
   - Keep peak_normalize after spatial processing (existing position).
   - Update the quality score computation and duration calculation.

3. Update `GenerationPipeline.export()`:
   - Accept optional `export_format: ExportFormat | None = None` and `metadata: dict | None = None` parameters.
   - If export_format is None, use ExportFormat from config.export_format string.
   - Use `export_audio()` from export.py instead of direct `export_wav()` call.
   - Pass metadata to export_audio for embedded tags.
   - Update auto-generated filename to use correct extension from FORMAT_EXTENSIONS.
   - Continue writing sidecar JSON for all formats (existing pattern).
   - Return (audio_path, json_path) as before but audio_path may be .mp3/.flac/.ogg.

Keep all backward compatibility: calling export() without new params produces WAV as before.
  </action>
  <verify>
    Run: `uv run python -c "from small_dataset_audio.inference.generation import GenerationConfig; c = GenerationConfig(); print(c.export_format, 'OK')"` outputs "wav OK".
    Run: `uv run python -c "from small_dataset_audio.inference.generation import GenerationConfig; c = GenerationConfig(export_format='mp3'); c.validate(); print('MP3 config OK')"` succeeds.
  </verify>
  <done>
    GenerationConfig has SpatialConfig and export_format fields. GenerationPipeline.generate uses apply_spatial for stereo/binaural/mono processing. GenerationPipeline.export dispatches to correct format via export_audio and embeds metadata. Backward compatibility preserved for old stereo_mode/stereo_width via transparent migration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Generate tab UI with format selector, spatial controls, multi-model blend panel, and editable metadata</name>
  <files>
    src/small_dataset_audio/ui/tabs/generate_tab.py
    src/small_dataset_audio/ui/state.py
    src/small_dataset_audio/ui/app.py
  </files>
  <action>
1. Update `src/small_dataset_audio/ui/state.py`:
   - Add `blend_engine: BlendEngine | None = None` to AppState (TYPE_CHECKING import for BlendEngine).
   - Add `loaded_models: list = []` to AppState for tracking multiple loaded models (list of loaded model references for the blend engine).

2. Update `src/small_dataset_audio/ui/tabs/generate_tab.py`:

   **A. Replace stereo controls with spatial controls:**
   - Replace `stereo_mode_dd` dropdown (choices: "mono", "mid_side", "dual_seed") with `output_mode_dd` dropdown (choices: ["mono", "stereo", "binaural"], default "mono", label "Output Mode").
   - Replace `stereo_width_slider` with `spatial_width_slider` (min 0.0, max 1.5, step 0.1, default 0.7, label "Spatial Width"). Visible when output mode is not "mono".
   - Add `spatial_depth_slider` (min 0.0, max 1.0, step 0.1, default 0.5, label "Spatial Depth"). Visible when output mode is not "mono".
   - Update `_toggle_stereo_width` to `_toggle_spatial_controls` -- shows/hides both width and depth sliders based on output mode.

   **B. Add format selector to export section:**
   - Replace "Export WAV" button with "Export" button.
   - Add `export_format_dd` dropdown (choices: ["wav", "mp3", "flac", "ogg"], default "wav", label "Format").
   - When format is "wav", show bit_depth dropdown. When format is "mp3"/"flac"/"ogg", hide bit_depth (each has fixed encoding settings).
   - Add editable metadata fields in an accordion ("Export Metadata", open=False):
     - `meta_artist` Textbox (default "SDA Generator", label "Artist")
     - `meta_album` Textbox (placeholder "model name", label "Album")
     - `meta_title` Textbox (placeholder "auto-generated", label "Title")

   **C. Add multi-model blend panel:**
   - Add collapsible accordion ("Multi-Model Blend", open=False) ABOVE the slider section.
   - Inside the accordion:
     - `blend_mode_radio` gr.Radio (choices=["latent", "audio"], value="latent", label="Blend Mode")
     - Up to 4 model rows (pre-created, hidden by default). Each row has:
       - `blend_model_dd_{i}` gr.Dropdown for model selection (populated from ModelLibrary)
       - `blend_weight_{i}` gr.Slider (min 0, max 100, step 1, default 25, label f"Weight {i+1}")
     - `add_blend_model_btn` gr.Button("Add Model") -- reveals next hidden model row
     - `remove_blend_model_btn` gr.Button("Remove Last") -- hides last model row
     - Status markdown showing current normalized weights.
   - When blend models are loaded, the slider section shows the union sliders from BlendEngine.get_union_sliders().

   **D. Update _generate_audio handler:**
   - Unpack new args: output_mode, spatial_width, spatial_depth (replacing stereo_mode, stereo_width).
   - Build SpatialConfig from output_mode, width, depth.
   - Set config.spatial = spatial_config.
   - If blend_engine has active models, call blend_engine.blend_generate() instead of pipeline.generate().
   - Otherwise, use single-model pipeline as before.

   **E. Update _export_audio handler:**
   - Accept format selection and metadata fields as inputs.
   - Build ExportFormat from string.
   - Build metadata dict from editable fields via build_export_metadata.
   - Call pipeline.export() with export_format and metadata params.
   - Update status message with exported format and path.

   **F. Update build_generate_tab return dict:**
   - Include new components needed for cross-tab wiring (blend model dropdowns need refresh on library changes).

3. Update `src/small_dataset_audio/ui/app.py` if needed:
   - Ensure cross-tab wiring includes blend model dropdown refresh when library content changes.
  </action>
  <verify>
    Run: `uv run python -c "from small_dataset_audio.ui.tabs.generate_tab import build_generate_tab; print('Generate tab imports OK')"` succeeds.
    Run: `uv run python -c "from small_dataset_audio.ui.state import app_state; print(hasattr(app_state, 'blend_engine'), 'blend_engine attr OK')"` outputs "True blend_engine attr OK".
  </verify>
  <done>
    Generate tab has output mode selector (stereo/binaural/mono) with spatial width+depth sliders. Export section supports WAV/MP3/FLAC/OGG format selection with editable metadata fields (artist, album, title). Multi-model blend accordion with up to 4 model slots, weight sliders, and blend mode toggle. All new controls wired to generation and export handlers. AppState has blend_engine reference.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from small_dataset_audio.inference.generation import GenerationConfig, GenerationPipeline; c = GenerationConfig(export_format='flac'); c.validate(); print('Pipeline integration OK')"` -- passes
2. `uv run python -c "from small_dataset_audio.ui.tabs.generate_tab import build_generate_tab; print('UI integration OK')"` -- passes
3. `uv run python -c "from small_dataset_audio.ui.state import app_state; assert hasattr(app_state, 'blend_engine'); print('State integration OK')"` -- passes
</verification>

<success_criteria>
- GenerationConfig accepts SpatialConfig and export_format
- GenerationPipeline uses apply_spatial for all spatial processing
- GenerationPipeline.export supports all 4 formats with metadata embedding
- Generate tab has output mode selector (stereo/binaural/mono) replacing old stereo controls
- Generate tab has spatial width + depth sliders adapting to selected output mode
- Generate tab has export format dropdown with editable metadata fields
- Generate tab has multi-model blend accordion with up to 4 model slots and weight sliders
- Blend mode toggle between latent-space and audio-domain visible in UI
- Backward compatibility maintained for old stereo_mode/stereo_width
</success_criteria>

<output>
After completion, create `.planning/phases/10-multi-format-export-spatial-audio/10-04-SUMMARY.md`
</output>
