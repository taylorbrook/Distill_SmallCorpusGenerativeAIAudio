---
phase: 10-multi-format-export-spatial-audio
plan: 05
type: execute
wave: 2
depends_on: ["10-01", "10-02", "10-03"]
files_modified:
  - src/small_dataset_audio/cli/generate.py
  - src/small_dataset_audio/cli/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can specify export format via CLI (--format wav/mp3/flac/ogg)"
    - "User can configure spatial audio via CLI (--spatial-mode stereo/binaural/mono, --spatial-width, --spatial-depth)"
    - "User can blend multiple models via CLI (--blend model1:weight model2:weight)"
    - "CLI exports include embedded metadata (artist, album, model name, seed)"
    - "Old --stereo flag still works via backward-compatible migration"
    - "All CLI Rich output goes to stderr, stdout reserved for file paths/JSON"
  artifacts:
    - path: "src/small_dataset_audio/cli/generate.py"
      provides: "Updated generate command with format, spatial, and blend options"
      contains: "--format"
  key_links:
    - from: "src/small_dataset_audio/cli/generate.py"
      to: "src/small_dataset_audio/inference/export.py"
      via: "CLI uses ExportFormat for --format option"
      pattern: "ExportFormat"
    - from: "src/small_dataset_audio/cli/generate.py"
      to: "src/small_dataset_audio/inference/spatial.py"
      via: "CLI uses SpatialConfig for --spatial-mode/width/depth"
      pattern: "SpatialConfig"
    - from: "src/small_dataset_audio/cli/generate.py"
      to: "src/small_dataset_audio/inference/blending.py"
      via: "CLI uses BlendEngine for --blend option"
      pattern: "BlendEngine"
---

<objective>
CLI integration for multi-format export, spatial audio, and multi-model blending.

Purpose: Enable power users and scripting workflows to access all Phase 10 features (format selection, spatial audio, model blending) via the command line. Maintains the existing CLI patterns (stderr for Rich, stdout for paths/JSON).

Output: Updated `sda generate` command with `--format`, `--spatial-mode`, `--spatial-width`, `--spatial-depth`, and `--blend` options.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-multi-format-export-spatial-audio/10-CONTEXT.md
@.planning/phases/10-multi-format-export-spatial-audio/10-RESEARCH.md
@.planning/phases/10-multi-format-export-spatial-audio/10-01-SUMMARY.md
@.planning/phases/10-multi-format-export-spatial-audio/10-02-SUMMARY.md
@.planning/phases/10-multi-format-export-spatial-audio/10-03-SUMMARY.md
@src/small_dataset_audio/cli/generate.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update sda generate with format, spatial, and blend CLI options</name>
  <files>
    src/small_dataset_audio/cli/generate.py
  </files>
  <action>
1. Update the `generate()` command function signature in `cli/generate.py`:

   **New options (add after existing options):**
   - `format_: str = typer.Option("wav", "--format", "-f", help="Export format: wav, mp3, flac, ogg")` -- note underscore to avoid shadowing builtin
   - `spatial_mode: str = typer.Option("mono", "--spatial-mode", help="Spatial mode: mono, stereo, binaural")` -- replaces `--stereo`
   - `spatial_width: float = typer.Option(0.7, "--spatial-width", help="Spatial width (0.0-1.5)")`
   - `spatial_depth: float = typer.Option(0.5, "--spatial-depth", help="Spatial depth (0.0-1.0)")`
   - `blend: Optional[list[str]] = typer.Option(None, "--blend", "-b", help="Blend models as MODEL:WEIGHT pairs (e.g., --blend 'model_a:60' --blend 'model_b:40')")`
   - `meta_artist: Optional[str] = typer.Option(None, "--artist", help="Override artist metadata tag")`
   - `meta_album: Optional[str] = typer.Option(None, "--album", help="Override album metadata tag")`
   - `meta_title: Optional[str] = typer.Option(None, "--title", help="Override title metadata tag")`

   **Keep the old `--stereo` option** for backward compatibility but mark it as deprecated in help text. If --stereo is provided but --spatial-mode is still default ("mono"), map --stereo to --spatial-mode via migrate_stereo_config.

2. Update the generate command body:

   **Format handling:**
   - Import ExportFormat from inference.export.
   - Validate format_ is one of "wav", "mp3", "flac", "ogg". Raise BadParameter if not.
   - Set gen_config.export_format = format_.

   **Spatial handling:**
   - Import SpatialConfig, SpatialMode from inference.spatial.
   - Build SpatialConfig from spatial_mode, spatial_width, spatial_depth.
   - If old --stereo was provided and spatial_mode was not explicitly set, use migrate_stereo_config for backward compatibility.
   - Set gen_config.spatial = spatial_config.

   **Blend handling:**
   - If `--blend` is provided:
     - Import BlendEngine from inference.blending.
     - Parse each blend argument as "MODEL_REF:WEIGHT" (split on last colon).
     - For each, resolve the model via resolve_model(), add to BlendEngine with parsed weight.
     - Console.print each loaded blend model.
     - Use BlendEngine.blend_generate() instead of pipeline.generate() in the generation loop.
   - If `--blend` is NOT provided, use single-model generation as before.

   **Metadata handling:**
   - Import build_export_metadata from audio.metadata.
   - Build overrides dict from meta_artist, meta_album, meta_title (only include non-None values).
   - Call build_export_metadata(model_name=loaded.metadata.name, seed=result.seed_used, preset_name=preset, overrides=overrides_dict).
   - Pass metadata to pipeline.export().

   **Export handling:**
   - Pass export_format and metadata to pipeline.export().
   - Auto-generated filename uses correct extension (gen_{timestamp}_seed{seed}.{ext}).
   - Console.print includes format in output message.
   - JSON output includes format in result dict.

   **Output path update:**
   - stdout prints the exported file path (may now be .mp3, .flac, .ogg instead of .wav).

3. Print deprecation warning via console.print if old --stereo flag is used:
   `[yellow]Warning:[/yellow] --stereo is deprecated. Use --spatial-mode instead.`
  </action>
  <verify>
    Run: `uv run python -m small_dataset_audio.cli --help` shows generate command.
    Run: `uv run python -c "from small_dataset_audio.cli.generate import generate; print('Generate command importable')"` succeeds.
  </verify>
  <done>
    sda generate supports --format (wav/mp3/flac/ogg), --spatial-mode (mono/stereo/binaural), --spatial-width, --spatial-depth, --blend (MODEL:WEIGHT pairs), and --artist/--album/--title metadata overrides. Old --stereo flag is backward-compatible with deprecation warning. Batch generation works with all new options. JSON output includes format. Rich output to stderr, file paths to stdout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Final integration verification and public API cleanup</name>
  <files>
    src/small_dataset_audio/cli/__init__.py
    src/small_dataset_audio/inference/__init__.py
  </files>
  <action>
1. Verify all public API re-exports in `src/small_dataset_audio/inference/__init__.py` include:
   - From export.py: ExportFormat, export_audio, export_wav, export_mp3, export_flac, export_ogg, write_sidecar_json, BIT_DEPTH_MAP, SAMPLE_RATE_OPTIONS
   - From spatial.py: SpatialMode, SpatialConfig, apply_spatial, migrate_stereo_config
   - From blending.py: BlendMode, BlendEngine, ModelSlot, MAX_BLEND_MODELS
   - From stereo.py: peak_normalize, create_dual_seed_stereo, apply_mid_side_widening (still used internally)
   - From generation.py: GenerationConfig, GenerationResult, GenerationPipeline
   - From chunking.py: slerp, crossfade_chunks, generate_chunks_crossfade, generate_chunks_latent_interp
   - From quality.py: compute_snr_db, detect_clipping, compute_quality_score
   - All symbols in __all__ list.

2. Verify `src/small_dataset_audio/cli/__init__.py` has clean imports for all CLI modules without try/except guards (matching Phase 9 decision to remove guards).

3. Run comprehensive import check:
   ```python
   # All Phase 10 symbols importable
   from small_dataset_audio.inference import (
       ExportFormat, export_audio,
       SpatialMode, SpatialConfig, apply_spatial,
       BlendMode, BlendEngine, ModelSlot,
       GenerationConfig, GenerationPipeline,
   )
   from small_dataset_audio.audio import (
       embed_metadata, build_export_metadata,
       HRTFData, load_hrtf, apply_binaural,
   )
   ```

4. Verify backward compatibility:
   - Old GenerationConfig with stereo_mode/stereo_width still validates.
   - Old export() with no format/metadata args still produces WAV.
   - Old CLI with --stereo flag still works (with deprecation warning).
  </action>
  <verify>
    Run: `uv run python -c "from small_dataset_audio.inference import ExportFormat, SpatialMode, BlendMode, GenerationConfig, GenerationPipeline; print('All Phase 10 inference imports OK')"` succeeds.
    Run: `uv run python -c "from small_dataset_audio.audio import embed_metadata, build_export_metadata, HRTFData, load_hrtf, apply_binaural; print('All Phase 10 audio imports OK')"` succeeds.
    Run: `uv run python -c "from small_dataset_audio.inference.generation import GenerationConfig; c = GenerationConfig(stereo_mode='mid_side', stereo_width=0.7); c.validate(); print('Backward compat OK')"` succeeds.
    Run: `uv run sda generate --help` shows --format, --spatial-mode, --spatial-width, --spatial-depth, --blend options.
  </verify>
  <done>
    All Phase 10 public API re-exports verified. CLI generate command has all new options. Backward compatibility confirmed for old stereo config, old export API, and old CLI --stereo flag. Full inference and audio package exports include all new symbols.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from small_dataset_audio.inference import ExportFormat, SpatialMode, SpatialConfig, BlendMode, BlendEngine; print('Phase 10 inference API complete')"` -- passes
2. `uv run python -c "from small_dataset_audio.audio import embed_metadata, build_export_metadata, HRTFData; print('Phase 10 audio API complete')"` -- passes
3. `uv run sda generate --help` includes --format, --spatial-mode, --blend options -- passes
4. `uv run python -c "from small_dataset_audio.inference.generation import GenerationConfig; c = GenerationConfig(stereo_mode='mono'); c.validate(); print('Backward compat OK')"` -- passes
5. `uv run sda --help` shows all commands (ui, generate, train, model) -- passes
</verification>

<success_criteria>
- sda generate --format wav/mp3/flac/ogg produces correct format files
- sda generate --spatial-mode stereo/binaural/mono with --spatial-width and --spatial-depth
- sda generate --blend 'model_a:60' --blend 'model_b:40' blends two models
- Exported files have embedded metadata (artist="SDA Generator", album=model name, seed, preset)
- --artist, --album, --title override default metadata
- Old --stereo flag works with deprecation warning
- All Phase 10 symbols accessible via package-level imports
- Full backward compatibility with Phases 4-9 functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-multi-format-export-spatial-audio/10-05-SUMMARY.md`
</output>
